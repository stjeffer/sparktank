<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Stage 4 — Vision Builder (Shared AI Vision Statement)</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1226; --ink:#e5e7eb; --muted:#94a3b8;
    --border:#1f2a3d; --shadow:0 16px 34px rgba(0,0,0,.42); --radius:18px;
    --blue:#60a5fa; --green:#34d399; --amber:#f59e0b; --violet:#a78bfa;
  }
  body{margin:0;background: radial-gradient(1200px 600px at 70% -10%, #172554 0%, #0b1226 45%, #050816 100%);color:var(--ink);
       font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:24px 24px 10px;display:flex;gap:16px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap}
  h1{margin:.2rem 0 .3rem;font-size:28px}
  .subtitle{color:var(--muted);max-width:960px}
  .bar{display:flex;gap:10px;flex-wrap:wrap}
  button{background:linear-gradient(180deg,#1f2937,#111827);color:var(--ink);border:1px solid #263041;
         padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow)}
  button:hover{transform:translateY(-1px);border-color:#3b82f6}
  .btn-accent{background:linear-gradient(180deg,#2563eb,#1d4ed8);border-color:#3b82f6}
  .btn-outline{background:transparent;border-color:#334155}
  .btn-green{background:linear-gradient(180deg,#10b981,#059669);border-color:#34d399}
  .wrap{display:grid;grid-template-columns: 380px 1fr 380px;gap:16px;padding:8px 18px 24px}
  .panel{background:linear-gradient(180deg,#0b1226,#050a1a);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .panel header{padding:12px 14px;border-bottom:1px solid var(--border)}
  .panel main{padding:12px 14px}
  .section-title{font-weight:700;margin:6px 0 8px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid #334155;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer;background:#0c1427;color:#cbd5e1}
  .chip.active{border-color:#3b82f6;box-shadow:inset 0 0 0 1px #3b82f6}
  .bank{display:grid;gap:8px;max-height:62vh;overflow:auto}
  .token{display:inline-flex;align-items:center;gap:8px;border:1px solid #2a3a56;background:#0c1427;color:#cbd5e1;padding:6px 10px;border-radius:12px}
  .token small{color:#9fb0ca}
  .area{display:grid;gap:10px}
  textarea,input[type=text]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a3a56;background:#0c1427;color:#e5e7eb}
  textarea{min-height:96px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .vote{display:flex;gap:8px;align-items:center}
  .vote .dot{width:10px;height:10px;border-radius:999px;background:#60a5fa}
  .option{background:linear-gradient(180deg,#0f172a,#0b1226);border:1px solid #22304a;border-radius:14px;padding:10px;position:relative}
  .option .toolbar{position:absolute;top:6px;right:6px;display:flex;gap:6px}
  .icon-btn{width:26px;height:26px;border-radius:8px;border:1px solid #334155;background:#0b1226;color:#cbd5e1;cursor:pointer}
  .small{font-size:12px;color:#9fb0ca}
  .counter{font-size:12px;color:#9fb0ca;text-align:right;margin-top:4px}
  .list{display:grid;gap:8px}
  .hint{font-size:12px;color:#9fb0ca}
  @media (max-width:1200px){ .wrap{grid-template-columns:1fr} }
</style>
</head>
<body>

<header>
  <div>
    <h1>Stage 4 — Vision Builder</h1>
    <div class="subtitle">
      Synthesize a concise, authentic <strong>Shared AI Vision Statement</strong> from your own Stage-1 changes and Stage-2/3 initiatives.
      Select themes, pick phrasing cues, compose 2–3 options, dot-vote, and export the final statement with supporting themes and evidence.
    </div>
  </div>
  <div class="bar">
    <label for="importFile" class="btn btn-outline" style="cursor:pointer">← Import Stage-3 Plan (JSON)</label>
    <input id="importFile" type="file" accept=".json" style="display:none"/>
    <button class="btn btn-outline" id="seed">Seed Mock Data</button>
    <button class="btn btn-outline" id="exportJSON">Export Vision (JSON)</button>
    <button class="btn btn-outline" id="exportMD">Export Vision (Markdown)</button>
    <button class="btn btn-green" onclick="window.print()">Print</button>
  </div>
</header>

<section class="wrap">

  <!-- LEFT: Word Bank + Themes -->
  <div class="panel">
    <header><strong>1) Word Bank & Themes</strong></header>
    <main>
      <div class="hint">Auto-extracted from your plan (KPI words, initiative names). Click to add to the composer.</div>
      <div id="bank" class="bank" style="margin:10px 0 14px"></div>

      <div class="section-title">Select Core Themes (pick 3–4)</div>
      <div id="themes" class="chips">
        <span class="chip">Empowered workforce</span>
        <span class="chip">Proactive customer value</span>
        <span class="chip">Intelligent operations</span>
        <span class="chip">Data-driven growth</span>
        <span class="chip">Responsible & trusted AI</span>
        <span class="chip">Faster innovation cycles</span>
      </div>

      <div class="section-title" style="margin-top:12px">Evidence Lines (metrics)</div>
      <div class="area">
        <textarea id="evidence" placeholder="e.g., 2 hrs/week saved per FTE • −25% inbound volume • <48h cycle time • 12 AI prototypes/year"></textarea>
      </div>
    </main>
  </div>

  <!-- CENTER: Composer -->
  <div class="panel">
    <header><strong>2) Compose Vision Options</strong></header>
    <main>
      <div class="row">
        <div>
          <div class="section-title">Phrasing Cards</div>
          <div id="phrases" class="chips">
            <span class="chip">We are an AI-empowered organization</span>
            <span class="chip">Every employee is augmented by Copilot</span>
            <span class="chip">We anticipate and personalize customer value</span>
            <span class="chip">Decisions move at the speed of data</span>
            <span class="chip">Innovation is a monthly habit</span>
            <span class="chip">Trust and responsibility by design</span>
          </div>
        </div>
        <div>
          <div class="section-title">Tone</div>
          <div class="chips" id="tone">
            <span class="chip">Ambitious</span>
            <span class="chip">Practical</span>
            <span class="chip">Customer-obsessed</span>
            <span class="chip">People-first</span>
            <span class="chip">Operational</span>
          </div>
        </div>
      </div>

      <div class="section-title" style="margin-top:10px">Compose (140–280 chars)</div>
      <textarea id="compose" placeholder="Draft a concise vision using your themes and phrasing. Click words in the bank to insert."></textarea>
      <div class="counter"><span id="charCount">0</span> chars</div>

      <div class="row">
        <button class="btn btn-accent" id="saveOption">+ Save as Option</button>
        <button class="btn btn-outline" id="clearCompose">Clear</button>
      </div>

      <div class="section-title" style="margin-top:10px">Options (vote for 1–2)</div>
      <div id="options" class="list"><em class="hint">Save 2–3 options, then vote.</em></div>
    </main>
  </div>

  <!-- RIGHT: Finalize -->
  <div class="panel">
    <header><strong>3) Finalize & Export</strong></header>
    <main>
      <div class="section-title">Winning Statement</div>
      <textarea id="final" placeholder="When voting ends, the top option will appear here for final tweaks."></textarea>
      <div class="counter"><span id="finalCount">0</span> chars</div>

      <div class="section-title" style="margin-top:8px">Supporting Themes</div>
      <input id="themesLine" type="text" placeholder="e.g., Empowered workforce • Proactive CX • Intelligent operations • Trusted AI"/>

      <div class="section-title" style="margin-top:8px">Why this matters (exec-ready)</div>
      <textarea id="why" placeholder="1–2 sentences connecting vision to revenue, differentiation, and risk posture."></textarea>

      <div class="section-title" style="margin-top:8px">Facilitator Note</div>
      <textarea id="note" placeholder="Any clarifications or commitments made during discussion."></textarea>
    </main>
  </div>
</section>

<script>
  // ---------------- State ----------------
  let bank = []; // {text, source}
  let options = []; // {id,text,votes}
  const themesSel = new Set();
  const toneSel = new Set();

  // ---------------- Helpers ----------------
  const q = s => document.querySelector(s);
  const qa = s => Array.from(document.querySelectorAll(s));
  const uid = () => Math.random().toString(36).slice(2,10);
  const esc = s => String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function renderBank(){
    const wrap = q('#bank'); wrap.innerHTML='';
    if(!bank.length){ wrap.innerHTML = '<em class="hint">Import plan or click “Seed Mock Data”.</em>'; return; }
    bank.forEach(tok=>{
      const el = document.createElement('div');
      el.className='token';
      el.innerHTML = `<span>${esc(tok.text)}</span><small>${esc(tok.source||'')}</small>`;
      el.title = 'Click to insert into composer';
      el.addEventListener('click', ()=> insertIntoComposer(tok.text));
      wrap.appendChild(el);
    });
  }
  function insertIntoComposer(text){
    const ta = q('#compose');
    const selStart = ta.selectionStart || ta.value.length;
    ta.value = ta.value.slice(0,selStart) + (ta.value && !ta.value.endsWith(' ')?' ':'') + text + ' ' + ta.value.slice(selStart);
    updateCounts();
    ta.focus();
  }
  function updateCounts(){
    q('#charCount').textContent = q('#compose').value.length;
    q('#finalCount').textContent = q('#final').value.length;
  }

  // Theme/tone toggles
  qa('#themes .chip').forEach(ch => ch.addEventListener('click', ()=>{
    ch.classList.toggle('active'); const t = ch.textContent.trim();
    ch.classList.contains('active') ? themesSel.add(t) : themesSel.delete(t);
    q('#themesLine').value = Array.from(themesSel).join(' • ');
  }));
  qa('#phrases .chip').forEach(ch => ch.addEventListener('click', ()=> insertIntoComposer(ch.textContent.trim())));
  qa('#tone .chip').forEach(ch => ch.addEventListener('click', ()=>{
    ch.classList.toggle('active'); const t = ch.textContent.trim();
    ch.classList.contains('active') ? toneSel.add(t) : toneSel.delete(t);
  }));

  // Save option
  q('#saveOption').addEventListener('click', ()=>{
    const text = q('#compose').value.trim();
    if(text.length < 60){ alert('Please write at least ~60 characters.'); return; }
    options.push({id:uid(), text, votes:0});
    q('#compose').value=''; updateCounts();
    renderOptions();
  });
  q('#clearCompose').addEventListener('click', ()=>{ q('#compose').value=''; updateCounts(); });

  function renderOptions(){
    const wrap = q('#options'); wrap.innerHTML='';
    if(!options.length){ wrap.innerHTML='<em class="hint">No options yet.</em>'; return; }
    options.forEach(opt=>{
      const div = document.createElement('div');
      div.className='option';
      div.innerHTML = `
        <div class="toolbar">
          <button class="icon-btn" title="Vote">●</button>
          <button class="icon-btn" title="Edit to composer">↺</button>
          <button class="icon-btn" title="Delete">🗑</button>
        </div>
        <div>${esc(opt.text)}</div>
        <div class="vote"><span class="dot"></span> <span class="small">Votes: <strong>${opt.votes}</strong></span></div>
      `;
      const [voteBtn, editBtn, delBtn] = div.querySelectorAll('.icon-btn');
      voteBtn.addEventListener('click', ()=>{ opt.votes++; pickWinner(); renderOptions(); });
      editBtn.addEventListener('click', ()=>{ q('#compose').value = opt.text; updateCounts(); });
      delBtn.addEventListener('click', ()=>{ options = options.filter(o=>o.id!==opt.id); pickWinner(); renderOptions(); });
      wrap.appendChild(div);
    });
  }

  function pickWinner(){
    if(!options.length){ q('#final').value=''; updateCounts(); return; }
    const top = [...options].sort((a,b)=>b.votes-a.votes)[0];
    q('#final').value = top.text;
    updateCounts();
  }

  // Import Stage-3 plan
  q('#importFile').addEventListener('change', e=>{
    const f = e.target.files[0]; if(!f) return;
    const fr = new FileReader();
    fr.onload = ()=>{
      try{
        const data = JSON.parse(fr.result);
        const plan = Array.isArray(data.plan) ? data.plan : Array.isArray(data) ? data : [];
        if(!plan.length) { alert('No initiatives found in JSON.'); return; }
        bank = extractTokens(plan);
        // preload themes/evidence from KPIs
        const ev = extractEvidence(plan);
        q('#evidence').value = ev.join(' • ');
        renderBank();
      }catch(err){ alert('Could not parse JSON.'); }
    };
    fr.readAsText(f);
  });

  function extractTokens(plan){
    const tokens = new Map();
    const push = (text, src) => {
      const t = text.trim().replace(/\s+/g,' ');
      if(!t) return; tokens.set(t, src);
    };
    plan.forEach(p=>{
      push(p.name||'', 'initiative');
      push(p.kpi||'', 'kpi');
      push(p.target||'', 'target');
      (p.enablers||[]).forEach(e=> push(e, 'enabler'));
      (p.milestones||[]).forEach(m=> push(m, 'milestone'));
    });
    return [...tokens].map(([text,source])=>({text,source}));
  }
  function extractEvidence(plan){
    const lines = [];
    plan.forEach(p=>{
      if(p.kpi && p.target) lines.push(`${p.kpi} ${p.target}`);
    });
    return lines.slice(0,8);
  }

  // Exports
  q('#exportJSON').addEventListener('click', ()=>{
    const payload = {
      generatedAt: new Date().toISOString(),
      finalStatement: q('#final').value.trim(),
      themes: q('#themesLine').value.trim(),
      why: q('#why').value.trim(),
      evidence: q('#evidence').value.trim(),
      tone: Array.from(toneSel),
      options: options
    };
    download('shared-ai-vision.json', JSON.stringify(payload,null,2));
  });

  q('#exportMD').addEventListener('click', ()=>{
    const md = `# Shared AI Vision Statement

**Vision (final):**
> ${q('#final').value.trim()}

**Supporting themes:** ${q('#themesLine').value.trim()}

**Why this matters:**  
${q('#why').value.trim()}

**Evidence lines:**  
- ${q('#evidence').value.trim().split('•').map(s=>s.trim()).filter(Boolean).join('\n- ')}

**Tone cues:** ${Array.from(toneSel).join(', ')}

**Considered options (with votes):**
${options.map(o=>`- ${o.text} _(votes: ${o.votes})_`).join('\n')}
`;
    download('shared-ai-vision.md', md);
  });

  function download(filename, text){
    const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
  }

  // Seed mock data
  q('#seed').addEventListener('click', ()=>{
    const mockPlan = [
      {lane:'employee', horizon:'0-3', name:'Employee Copilot pilot', kpi:'Hrs saved / FTE', target:'2 hrs/wk', enablers:['Skills','Technology'], milestones:['Pilot','Feedback','Scale']},
      {lane:'customer', horizon:'3-6', name:'Predictive Service Copilot', kpi:'Inbound volume', target:'-25%', enablers:['Data','Technology'], milestones:['Model ready','CX training']},
      {lane:'process', horizon:'6-12', name:'Workflow Orchestrator', kpi:'Cycle time', target:'< 48h', enablers:['Governance','Technology','Data']},
      {lane:'innovation', horizon:'6-12', name:'AI Product Studio', kpi:'Prototypes/year', target:'12', enablers:['Culture','Skills','Technology']},
    ];
    bank = extractTokens(mockPlan);
    q('#evidence').value = extractEvidence(mockPlan).join(' • ');
    renderBank();

    // add two example options
    options = [
      {id:uid(), votes:2, text:'We are an AI-empowered organization where every employee is augmented by Copilot, customer needs are anticipated, and decisions move at the speed of data — turning innovation into a monthly habit with trust by design.'},
      {id:uid(), votes:1, text:'In 12 months we operate as a trusted, data-driven enterprise: employees focus on high-value work, customer engagement is proactive, and intelligent operations shorten cycle time from weeks to days.'}
    ];
    renderOptions(); pickWinner();
    // default themes
    ['Empowered workforce','Proactive customer value','Intelligent operations','Responsible & trusted AI'].forEach(t=>{
      qa('#themes .chip').find(c=>c.textContent.trim()===t)?.classList.add('active'); themesSel.add(t);
    });
    q('#themesLine').value = Array.from(themesSel).join(' • ');
  });

  // counters
  q('#compose').addEventListener('input', updateCounts);
  q('#final').addEventListener('input', updateCounts);
  updateCounts(); renderBank(); renderOptions();
</script>
</body>
</html>
