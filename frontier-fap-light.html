<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Frontier — FAP Sequencing (Light, Alignment & Chart)</title>
<style>
  :root{
    --bg:#f7fafc; --card:#ffffff; --ink:#1f2937; --muted:#556581;
    --primary:#3b82f6; --primary-600:#2563eb; --accent:#10b981; --warn:#f59e0b; --danger:#ef4444; --violet:#8b5cf6;
    --border:#e5e7eb; --shadow:0 10px 24px rgba(31,41,55,.12); --radius:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--ink);
    background: radial-gradient(1100px 480px at 80% -10%, #e8f1ff 0%, #f5fbff 40%, var(--bg) 70%);
    font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  header{padding:18px 18px 8px; display:flex; gap:16px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap}
  h1{margin:.2rem 0 .3rem; font-size:26px}
  .sub{color:var(--muted); max-width:980px}
  .nav{display:flex; gap:8px; flex-wrap:wrap}
  .tab{background:#fff; border:1px solid #d8dee8; color:#1f2937; padding:8px 12px; border-radius:10px; cursor:pointer}
  .tab.active{border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.18) inset}
  .wrap{padding:10px 18px 24px; display:grid; gap:16px}
  .panel{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
  .panel header{padding:12px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
  .panel main{padding:14px}

  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .btn{background:#eff6ff; color:#0f3a8a; border:1px solid #cfe0ff; padding:10px 14px; border-radius:12px; cursor:pointer}
  .btn:hover{background:#e6f0ff}
  .btn-primary{background:linear-gradient(180deg,#60a5fa,#3b82f6); color:#fff; border:1px solid #3b82f6}
  .btn-ghost{background:#fff; border:1px solid #d8dee8; color:#334155}
  .btn-warn{background:#fff7ed; color:#9a3412; border:1px solid #fed7aa}
  .btn-small{padding:6px 10px; border-radius:10px; font-size:14px}

  input, select{background:#fff; border:1px solid #d8dee8; color:#1f2937; border-radius:12px; padding:10px 12px}
  input:focus, select:focus{outline:none; border-color:#c4d5ff; box-shadow:0 0 0 3px rgba(59,130,246,.15)}
  label{display:block; font-size:13px; color:#42506b; margin:8px 0 6px}

  .hint{font-size:12px; color:#6b7280}
  .status{font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #e2e8f0}
  .s-open{background:#f0f9ff; color:#075985; border-color:#bae6fd}
  .s-locked{background:#fff7ed; color:#9a3412; border-color:#fed7aa}
  .timer{font-variant-numeric:tabular-nums; font-weight:700; font-size:26px; letter-spacing:.5px}

  /* Team board */
  .columns{display:grid; grid-template-columns: 340px 1fr; gap:16px}
  .stack{background:#fff; border:1px dashed #d8dee8; border-radius:14px; padding:10px; min-height:120px}
  .cards{display:grid; gap:10px}
  .card{background:#fff; border:1px solid #e7ecf4; border-radius:12px; padding:10px; box-shadow:0 6px 14px rgba(15,23,42,.06)}
  .i-meta{color:#556581; font-size:13px}
  .drag{cursor:grab}
  .board{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px}
  .lane{background:#fff; border:2px dashed #d8dee8; border-radius:14px; min-height:220px; padding:10px}
  .lane.drop{background:#f0f9ff; border-color:#93c5fd}
  .lane h3{text-align:center; margin:0 0 8px; color:#1f3a8a}
  .badge{background:#ecfeff; color:#155e75; border:1px solid #bae6fd; padding:2px 8px; border-radius:999px; font-size:12px}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #d7e0ee; font-size:12px; background:#f8fafc; color:#334155}
  .icard{background:#fff; border:1px solid #e7ecf4; border-radius:12px; padding:8px; margin:8px 0; box-shadow:0 6px 14px rgba(15,23,42,.06)}
  .muted{color:#6b7280; font-size:13px}
  .empty{padding:12px; border:2px dashed #d8dee8; border-radius:10px; color:#6b7280; background:#fbfdff}

  /* Facilitator grid & alignment */
  .gridwrap{display:grid; grid-template-columns: 1fr 340px; gap:16px}
  .gridboard{overflow:auto}
  .hdr{display:grid; grid-template-columns: 220px repeat(3, 1fr); gap:1px; padding:8px 10px; border-bottom:1px solid var(--border)}
  .col-h{border:1px solid #d8dee8; border-radius:10px; text-align:center; padding:6px; font-weight:700}
  .table{display:grid; grid-template-columns: 220px repeat(3, 1fr); gap:1px}
  .rowlab{padding:10px; border-right:1px solid #e5e7eb; font-weight:600}
  .cell{min-height:130px; border-left:1px solid #e5e7eb; border-bottom:1px solid #e5e7eb; padding:8px; display:flex; gap:8px; flex-wrap:wrap; align-content:flex-start}
  .card-mini{background:#fff; border:1px solid #e7ecf4; border-radius:10px; padding:8px; box-shadow:0 6px 14px rgba(15,23,42,.06); position:relative}
  .align-ok{box-shadow:0 0 0 2px rgba(16,185,129,.35) inset}
  .align-off{box-shadow:0 0 0 2px rgba(245,158,11,.35) inset}
  .align-div{box-shadow:0 0 0 2px rgba(139,92,246,.35) inset}
  .flag{position:absolute; top:6px; right:6px; font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid #e2e8f0}
  .f-ok{background:#ecfdf5; color:#065f46; border-color:#a7f3d0}
  .f-off{background:#fffbeb; color:#92400e; border-color:#fde68a}
  .f-div{background:#f5f3ff; color:#5b21b6; border-color:#ddd6fe}
  .sidepanel{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px}
  .sidepanel h4{margin:2px 0 8px}
  .alist{display:grid; gap:10px; max-height:58vh; overflow:auto}
  .aline{font-size:14px; color:#334155}
  .aline small{color:#6b7280}

  /* Chart */
  .chartbox{background:#fff; border:1px solid #e7ecf4; border-radius:14px; padding:10px; box-shadow:0 6px 14px rgba(15,23,42,.06)}
  .legend{display:flex; gap:8px; flex-wrap:wrap; font-size:12px; color:#334155}
  .legend .dot{width:10px; height:10px; border-radius:999px; display:inline-block}
</style>
</head>
<body>

<header>
  <div>
    <h1>Frontier Action Plan — Sequencing</h1>
    <div class="sub">Teams drag the <strong>top initiatives</strong> into <strong>0–3</strong> / <strong>3–6</strong> / <strong>6–12 months</strong>. Facilitator sees live updates, <strong>alignment</strong> across teams, and a <strong>balance chart</strong>. Activity locks after <strong>20 minutes</strong>.</div>
  </div>
  <nav class="nav" id="nav"></nav>
</header>

<section class="wrap">
  <!-- TEAM SCREEN -->
  <div id="screen-team" class="panel" style="display:none">
    <header>
      <strong>Team Board</strong>
      <div class="row"><div class="status" id="lockStateTeam">OPEN</div><span class="hint">Select your team and sequence the initiatives.</span></div>
    </header>
    <main>
      <div class="row">
        <div>
          <label for="teamSelect">Team *</label>
          <select id="teamSelect">
            <!-- populated in JS -->
          </select>
        </div>
        <div>
          <label for="teamColor">Color</label>
          <input id="teamColor" type="color" value="#60a5fa"/>
        </div>
        <button class="btn btn-ghost" id="saveTeam">Save</button>
        <span class="hint">Saved locally for this browser.</span>
      </div>

      <div class="columns" style="margin-top:10px">
        <!-- backlog -->
        <div>
          <div class="card">
            <div class="row" style="justify-content:space-between">
              <strong>Top initiatives (drag to timeline)</strong>
              <button class="btn btn-ghost btn-small" id="seedTop">Seed examples</button>
            </div>
            <div id="backlog" class="stack"></div>
            <div class="hint" style="margin-top:8px">Tip: Prioritize by revenue impact first.</div>
          </div>
        </div>
        <!-- lanes -->
        <div>
          <div class="board">
            <div class="lane" data-h="0-3">
              <h3>0–3 months</h3>
              <div class="muted">Quick wins / foundation</div>
              <div class="lane-body" id="lane-0-3"></div>
            </div>
            <div class="lane" data-h="3-6">
              <h3>3–6 months</h3>
              <div class="muted">Scale-ups</div>
              <div class="lane-body" id="lane-3-6"></div>
            </div>
            <div class="lane" data-h="6-12">
              <h3>6–12 months</h3>
              <div class="muted">Transformational</div>
              <div class="lane-body" id="lane-6-12"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- FACILITATOR SCREEN -->
  <div id="screen-fac" class="panel" style="display:none">
    <header>
      <strong>Facilitator — Live Sequencing</strong>
      <div class="row">
        <div id="lockStateFac" class="status s-open">OPEN</div>
        <span class="timer" id="timer">20:00</span>
        <button class="btn btn-ghost btn-small" id="startTimer">Start</button>
        <button class="btn btn-ghost btn-small" id="pauseTimer">Pause</button>
        <button class="btn btn-ghost btn-small" id="resetTimer">Reset</button>
        <button class="btn btn-warn btn-small" id="lockNow">Lock now</button>
        <button class="btn btn-ghost btn-small" id="exportJSON">Export plan (JSON)</button>
      </div>
    </header>
    <main>
      <div class="gridwrap">
        <div class="gridboard">
          <div class="hdr">
            <div></div>
            <div class="col-h">0–3 months</div>
            <div class="col-h">3–6 months</div>
            <div class="col-h">6–12 months</div>
          </div>
          <div id="grid" class="table"></div>
        </div>

        <aside class="sidepanel">
          <h4>Balance (All Teams)</h4>
          <div class="chartbox">
            <canvas id="donut" width="300" height="220" aria-label="Portfolio balance"></canvas>
            <div class="legend" style="margin-top:6px">
              <span><span class="dot" style="background:#3b82f6"></span> 0–3</span>
              <span><span class="dot" style="background:#10b981"></span> 3–6</span>
              <span><span class="dot" style="background:#f59e0b"></span> 6–12</span>
            </div>
          </div>

          <h4 style="margin-top:14px">Alignment Summary</h4>
          <div id="alignList" class="alist">
            <div class="hint">As teams place the same initiative, we detect consensus or divergence.</div>
          </div>
        </aside>
      </div>
      <div class="hint" style="margin-top:10px">Cards show alignment badges: <span class="f-ok flag">Aligned</span> <span class="f-off flag">Off</span> <span class="f-div flag">Divergent</span></div>
    </main>
  </div>
</section>

<script>
  /* ---------- Demo teams for dropdown ---------- */
  const DEMO_TEAMS = [
    { name:'Team Nova', color:'#60a5fa' },
    { name:'Team Atlas', color:'#34d399' },
    { name:'Team Quasar', color:'#f59e0b' },
    { name:'Team Meridian', color:'#a78bfa' },
    { name:'Team Horizon', color:'#fb7185' },
    { name:'Team Vertex', color:'#22d3ee' },
  ];

  /* ---------- Real-time channel ---------- */
  const chan = new BroadcastChannel('frontier-fap-2');
  function publish(type, payload){ chan.postMessage({type, payload}); }

  /* ---------- State ---------- */
  let locked = false;
  let team = { name: localStorage.getItem('fap2.team') || '', color: localStorage.getItem('fap2.color') || '#60a5fa' };
  let backlog = []; // {id,title,pillar,kpi,target}
  let placed = { '0-3':[], '3-6':[], '6-12':[] }; // team local placements
  // facilitator: { [teamName]: { color, lanes: { '0-3':[], '3-6':[], '6-12':[] } } }
  let facState = {};

  /* ---------- UI helpers ---------- */
  const q = sel => document.querySelector(sel);
  const qa = sel => Array.from(document.querySelectorAll(sel));
  const uid = () => Math.random().toString(36).slice(2,10);
  const esc = s => String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  /* ---------- Router ---------- */
  const screens = [
    {id:'screen-team', label:'Team'},
    {id:'screen-fac', label:'Facilitator'}
  ];
  let current = 0;
  function renderNav(){
    const nav = q('#nav'); nav.innerHTML='';
    screens.forEach((s,i)=>{
      const b = document.createElement('button');
      b.className = 'tab'+(i===current?' active':'');
      b.textContent = s.label;
      b.addEventListener('click', ()=> show(i));
      nav.appendChild(b);
    });
  }
  function show(i){
    current = i; renderNav();
    screens.forEach((s,idx)=> q('#'+s.id).style.display = idx===i?'block':'none');
    if(i===0) renderTeam();
    if(i===1) renderFac();
  }

  /* ---------- Seed top 10 initiatives ---------- */
  function mkTop(title,pillar,kpi,target){ return { id:uid(), title, pillar, kpi, target }; }
  function seedTopData(){
    backlog = [
      mkTop('Employee Copilot pilot (HR & Sales)','employee','Hrs saved / FTE','2 hrs/wk'),
      mkTop('AI meeting recaps + next-step assistant','employee','Adoption','>70%'),
      mkTop('AI Sales Companion (next-best-offer)','customer','Win rate','+10%'),
      mkTop('Proactive service (resolve before call)','customer','Inbound volume','-25%'),
      mkTop('Workflow orchestrator (CRM↔ERP)','process','Cycle time','< 48h'),
      mkTop('Self-serve analytics w/ Copilot','employee','DIY reports','70%'),
      mkTop('Compliance monitor agent','process','Audit findings','-40%'),
      mkTop('AI Product Studio (monthly demos)','innovation','Prototypes/yr','12'),
      mkTop('Data monetization pilot','innovation','Data ARR','$600k'),
      mkTop('Customer personalization engine','customer','AOV','+7%'),
    ];
    renderTeam();
  }

  /* ---------- TEAM SCREEN ---------- */
  function renderTeam(){
    q('#lockStateTeam').textContent = locked ? 'LOCKED' : 'OPEN';
    q('#lockStateTeam').className = 'status ' + (locked?'s-locked':'s-open');

    // populate dropdown once
    const sel = q('#teamSelect');
    if(!sel.dataset.ready){
      sel.innerHTML = `<option value="">Select a team…</option>` + DEMO_TEAMS.map(t=>`<option value="${t.name}" data-color="${t.color}">${t.name}</option>`).join('');
      sel.dataset.ready = '1';
      // restore selection
      if(team.name){
        sel.value = team.name;
        const opt = sel.querySelector(`option[value="${CSS.escape(team.name)}"]`);
        if(opt){ q('#teamColor').value = opt.dataset.color || team.color; }
      }
      sel.addEventListener('change', ()=>{
        const opt = sel.selectedOptions[0];
        if(!opt || !opt.value) return;
        q('#teamColor').value = opt.dataset.color || '#60a5fa';
      });
    }

    // enable/disable inputs on lock
    qa('#screen-team input, #screen-team select, #screen-team button').forEach(el=>{
      if(el.id==='seedTop' || el.id==='saveTeam') return;
      el.disabled = locked;
    });

    // backlog render
    const bl = q('#backlog'); bl.innerHTML='';
    if(backlog.length===0) {
      bl.innerHTML = `<div class="empty">No items yet — click “Seed examples” to load the top 10.</div>`;
    } else {
      backlog.forEach(item => bl.appendChild(renderBacklogCard(item)));
    }

    // lanes
    ['0-3','3-6','6-12'].forEach(h=>{
      const laneBody = q('#lane-'+h.replace('-','-'));
      laneBody.innerHTML='';
      if(placed[h].length===0){
        const d = document.createElement('div');
        d.className='muted'; d.textContent='Drop initiatives here';
        laneBody.appendChild(d);
      } else {
        placed[h].forEach(item => laneBody.appendChild(renderPlacedCard(item, h)));
      }
    });

    // DnD
    qa('.lane').forEach(l=>{
      l.addEventListener('dragover', e=>{ if(locked) return; e.preventDefault(); l.classList.add('drop'); });
      l.addEventListener('dragleave', ()=> l.classList.remove('drop'));
      l.addEventListener('drop', e=>{
        if(locked) return;
        e.preventDefault(); l.classList.remove('drop');
        const id = e.dataTransfer.getData('text/plain');
        const h = l.dataset.h;
        moveItemToLane(id, h);
      });
    });
  }

  function renderBacklogCard(item){
    const c = document.createElement('div');
    c.className = 'card drag'; c.draggable = !locked; c.id = 'bl_'+item.id;
    c.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', item.id));
    c.innerHTML = `
      <div><strong>${esc(item.title)}</strong></div>
      <div class="i-meta">Pillar: <span class="pill">${esc(cap(item.pillar))}</span></div>
      <div class="i-meta">KPI: <strong>${esc(item.kpi)}</strong> → <strong>${esc(item.target)}</strong></div>
    `;
    return c;
  }

  function renderPlacedCard(item, h){
    const c = document.createElement('div');
    c.className = 'icard drag'; c.draggable = !locked; c.id = 'pl_'+item.id;
    c.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', item.id));
    c.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div><strong>${esc(item.title)}</strong></div>
        <span class="badge">${h}</span>
      </div>
      <div class="i-meta">KPI: <strong>${esc(item.kpi)}</strong> → <strong>${esc(item.target)}</strong></div>
    `;
    return c;
  }

  function moveItemToLane(id, horizon){
    let item;
    const idx = backlog.findIndex(x=>x.id===id);
    if(idx>-1){ item = backlog.splice(idx,1)[0]; }
    else {
      for(const h of ['0-3','3-6','6-12']){
        const j = placed[h].findIndex(x=>x.id===id);
        if(j>-1){ item = placed[h].splice(j,1)[0]; break; }
      }
    }
    if(!item) return;
    placed[horizon].push(item);
    renderTeam();

    if(team.name){
      publish('place', { team: team.name, color: team.color, horizon, item });
      upsertFac(team.name, team.color, horizon, item);
    }
  }

  q('#seedTop').addEventListener('click', seedTopData);
  q('#saveTeam').addEventListener('click', ()=>{
    const sel = q('#teamSelect');
    const opt = sel.selectedOptions[0];
    if(!opt || !opt.value){ alert('Select a team'); return; }
    const color = q('#teamColor').value;
    team = { name: opt.value, color };
    localStorage.setItem('fap2.team', team.name);
    localStorage.setItem('fap2.color', color);
    publish('hello', { team:team.name, color:team.color });
    // push current placements (on refresh)
    ['0-3','3-6','6-12'].forEach(h=> placed[h].forEach(item => publish('place', {team:team.name, color:team.color, horizon:h, item})));
  });

  /* ---------- FACILITATOR: state & rendering ---------- */
  function upsertFac(teamName, color, horizon, item){
    if(!facState[teamName]) facState[teamName] = { color, lanes: {'0-3':[], '3-6':[], '6-12':[]} };
    // remove previous placements of this id
    ['0-3','3-6','6-12'].forEach(h=>{
      facState[teamName].lanes[h] = facState[teamName].lanes[h].filter(x=>x.id!==item.id && x.title!==item.title);
    });
    facState[teamName].lanes[horizon].push(item);
  }

  function computeAlignment(){
    // title-normalized -> horizon counts
    const norm = s => s.toLowerCase().replace(/\s+/g,' ').trim();
    const dist = {}; // { titleKey: {title, counts:{'0-3':n,'3-6':n,'6-12':n}, total, topH, topCount, status } }
    Object.values(facState).forEach(t=>{
      ['0-3','3-6','6-12'].forEach(h=>{
        (t.lanes[h]||[]).forEach(it=>{
          const k = norm(it.title);
          if(!dist[k]) dist[k] = { title: it.title, counts:{'0-3':0,'3-6':0,'6-12':0}, total:0, topH:null, topCount:0, status:'div' };
          dist[k].counts[h]++; dist[k].total++;
        });
      });
    });
    Object.values(dist).forEach(d=>{
      let topH = '0-3', topCount = d.counts['0-3'];
      ['3-6','6-12'].forEach(h=>{ if(d.counts[h]>topCount){ topH=h; topCount=d.counts[h]; }});
      d.topH = topH; d.topCount = topCount;
      // status: if total<2 => not enough; if clear majority (topCount>=2 and topCount > total/2) => aligned; if tie across horizons => divergent
      if(d.total<2){ d.status='weak'; }
      else if( (topCount > d.total/2) ){ d.status='ok'; }
      else { d.status='div'; }
    });
    return dist;
  }

  function renderFac(){
    const st = q('#lockStateFac');
    st.textContent = locked ? 'LOCKED' : 'OPEN';
    st.className = 'status ' + (locked ? 's-locked' : 's-open');

    const grid = q('#grid'); grid.innerHTML='';
    const names = Object.keys(facState);
    if(!names.length){
      // seed blank rows for demo
      DEMO_TEAMS.forEach(t=>{ if(!facState[t.name]) facState[t.name]={color:t.color,lanes:{'0-3':[],'3-6':[],'6-12':[]}}; });
    }

    const align = computeAlignment();

    Object.entries(facState).sort((a,b)=> a[0].localeCompare(b[0])).forEach(([name, val])=>{
      const lab = document.createElement('div');
      lab.className = 'rowlab';
      lab.innerHTML = `<strong>${esc(name)}</strong>`;
      grid.appendChild(lab);

      ['0-3','3-6','6-12'].forEach(h=>{
        const cell = document.createElement('div'); cell.className='cell';
        const items = (val.lanes[h]||[]);
        if(!items.length){
          cell.innerHTML = `<div class="muted">—</div>`;
        }else{
          items.forEach(it=>{
            const k = it.title.toLowerCase().replace(/\s+/g,' ').trim();
            const a = align[k] || {status:'weak', topH:h, topCount:1, total:1};
            const cls = a.status==='ok' ? 'align-ok' : a.status==='div' ? 'align-div' : (a.topH!==h ? 'align-off' : ''); // off if minority horizon
            const flag = a.status==='ok' && a.topH===h ? `<span class="flag f-ok">Aligned (${a.topCount}/${a.total})</span>`
                      : (a.status==='div' ? `<span class="flag f-div">Divergent</span>`
                      : (a.topH!==h && a.total>1 ? `<span class="flag f-off">Off (top: ${a.topH})</span>` : ''));
            const d = document.createElement('div');
            d.className = 'card-mini '+cls;
            d.innerHTML = `${flag}<div><strong>${esc(it.title)}</strong></div>
                           <div class="muted">KPI <strong>${esc(it.kpi||'')}</strong> → <strong>${esc(it.target||'')}</strong></div>`;
            cell.appendChild(d);
          });
        }
        grid.appendChild(cell);
      });
    });

    // update side Alignment Summary
    renderAlignmentList(align);
    // update donut chart (balance across horizons)
    renderDonut();
  }

  function renderAlignmentList(align){
    const list = q('#alignList'); list.innerHTML='';
    const entries = Object.values(align);
    if(!entries.length){ list.innerHTML = `<div class="hint">No data yet.</div>`; return; }
    // sort: aligned first (by topCount desc), then divergent, then weak
    entries.sort((a,b)=>{
      const rank = v => v.status==='ok' ? 0 : v.status==='div' ? 1 : 2;
      return (rank(a)-rank(b)) || (b.topCount-a.topCount);
    });
    entries.forEach(d=>{
      const row = document.createElement('div');
      const badge = d.status==='ok' ? '<span class="flag f-ok">Aligned</span>' : d.status==='div' ? '<span class="flag f-div">Divergent</span>' : '<span class="flag f-off">Weak</span>';
      row.className = 'aline';
      row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div><strong>${esc(d.title)}</strong><br/><small>0–3:${d.counts['0-3']} • 3–6:${d.counts['3-6']} • 6–12:${d.counts['6-12']}</small></div>
        ${badge}
      </div>`;
      list.appendChild(row);
    });
  }

  /* ---------- Donut chart (pure Canvas) ---------- */
  function balanceCounts(){
    const c = {'0-3':0,'3-6':0,'6-12':0};
    Object.values(facState).forEach(t=>{
      ['0-3','3-6','6-12'].forEach(h=>{
        c[h] += (t.lanes[h]||[]).length;
      });
    });
    return c;
  }
  function renderDonut(){
    const canvas = q('#donut'); if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);
    const r = 90, cx = W/2, cy = H/2 - 5, inner = 52;
    const colors = {'0-3':'#3b82f6','3-6':'#10b981','6-12':'#f59e0b'};
    const counts = balanceCounts();
    const total = Math.max(1, counts['0-3']+counts['3-6']+counts['6-12']);
    // arcs
    let start = -Math.PI/2;
    ['0-3','3-6','6-12'].forEach(h=>{
      const frac = counts[h]/total;
      const end = start + frac*2*Math.PI;
      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end); ctx.closePath();
      ctx.fillStyle = colors[h]; ctx.globalAlpha = 0.85; ctx.fill();
      start = end;
    });
    // donut hole
    ctx.globalAlpha = 1; ctx.fillStyle = '#ffffff'; ctx.beginPath(); ctx.arc(cx,cy,inner,0,2*Math.PI); ctx.fill();
    // center label
    ctx.fillStyle = '#475569'; ctx.font = '12px system-ui, -apple-system, Segoe UI';
    ctx.textAlign = 'center';
    ctx.fillText('Portfolio balance', cx, cy-2);
    ctx.font = 'bold 14px system-ui, -apple-system, Segoe UI';
    ctx.fillText(`${total} initiatives`, cx, cy+16);
  }

  /* ---------- Export (facilitator) ---------- */
  q('#exportJSON').addEventListener('click', ()=>{
    const payload = {
      generatedAt: new Date().toISOString(),
      locked,
      teams: Object.entries(facState).map(([name, val])=>({
        team: name,
        color: val.color,
        lanes: val.lanes
      }))
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='frontier-fap-plan.json'; a.click(); URL.revokeObjectURL(a.href);
  });

  /* ---------- Timer (20:00) ---------- */
  let remaining = 20*60; // seconds
  let handle = null;
  function fmt(sec){ const m = Math.floor(sec/60), s = sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
  function tick(){
    if(remaining<=0){ clearInterval(handle); handle=null; q('#timer').textContent='00:00'; lockAll(false); return; }
    remaining--; q('#timer').textContent = fmt(remaining);
  }
  q('#startTimer').addEventListener('click', ()=>{ if(locked || handle) return; handle = setInterval(tick,1000); });
  q('#pauseTimer').addEventListener('click', ()=>{ if(handle){ clearInterval(handle); handle=null; }});
  q('#resetTimer').addEventListener('click', ()=>{ if(handle){ clearInterval(handle); handle=null; } remaining=20*60; q('#timer').textContent=fmt(remaining); });
  q('#lockNow').addEventListener('click', ()=> lockAll(true));
  function lockAll(manual){
    if(locked) return;
    locked = true;
    publish('lock', {at:new Date().toISOString(), manual});
    renderTeam(); renderFac();
  }

  /* ---------- Channel listeners ---------- */
  chan.onmessage = (e)=>{
    const {type, payload} = e.data || {};
    switch(type){
      case 'hello':
        facState[payload.team] = facState[payload.team] || { color: payload.color, lanes: {'0-3':[],'3-6':[],'6-12':[]} };
        renderFac();
        break;
      case 'place':
        upsertFac(payload.team, payload.color, payload.horizon, payload.item);
        renderFac();
        break;
      case 'lock':
        locked = true; renderTeam(); renderFac();
        break;
    }
  };

  /* ---------- Init ---------- */
  function init(){
    renderNav(); show(0); // default Team
    // populate dropdown now
    // (restored selection handled in renderTeam)
    // seed top initiatives so teams can start
    seedTopData();
    // if team already saved, announce
    if(team.name){ publish('hello', team); }
    // init facilitator timer display
    q('#timer').textContent = fmt(remaining);
  }
  init();

  // util
  function cap(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : s; }
</script>
</body>
</html>
