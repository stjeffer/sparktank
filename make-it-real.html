<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stage 2 — Action Builder: How do we make it happen?</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1226; --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
    --accent:#60a5fa; --green:#34d399; --yellow:#f59e0b; --red:#ef4444;
    --border:#1f2a3d; --radius:18px; --shadow:0 10px 28px rgba(0,0,0,.38);
  }
  body{margin:0;background: radial-gradient(1200px 600px at 70% -10%, #172554 0%, #0b1226 45%, #050816 100%);color:var(--ink);
       font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:24px 24px 12px;display:flex;gap:16px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap}
  h1{margin:.2rem 0 .3rem;font-size:28px}
  .subtitle{color:var(--muted);max-width:900px}
  .bar{display:flex;gap:10px;flex-wrap:wrap}
  button{background:linear-gradient(180deg,#1f2937,#111827);color:var(--ink);border:1px solid #263041;
         padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow)}
  button:hover{transform:translateY(-1px);border-color:#3b82f6}
  .btn-accent{background:linear-gradient(180deg,#2563eb,#1d4ed8);border-color:#3b82f6}
  .btn-green{background:linear-gradient(180deg,#10b981,#059669);border-color:#34d399}
  .btn-outline{background:transparent;border-color:#334155}
  .wrap{display:grid;grid-template-columns: 370px 1fr;gap:16px;padding:8px 18px 24px}
  /* Left column */
  .panel{background:linear-gradient(180deg,#0b1226,#050a1a);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .panel header{padding:14px 14px 12px;border-bottom:1px solid var(--border)}
  .list{padding:10px 10px 14px;display:grid;gap:10px;max-height:70vh;overflow:auto}
  .diff{background:linear-gradient(180deg,#0f172a,#0b1226);border:1px solid #22304a;border-radius:14px;padding:10px;cursor:pointer}
  .diff small{color:var(--muted)}
  .pill{display:inline-block;margin-top:6px;padding:2px 8px;border-radius:999px;border:1px solid #2a3a56;font-size:12px;color:#cbd5e1}
  .lane-emp{background:#0b3a2b;border-color:#14532d;color:#a7f3d0}
  .lane-cust{background:#122b49;border-color:#1e40af;color:#bae6fd}
  .lane-proc{background:#3b1a0b;border-color:#7c2d12;color:#fed7aa}
  .lane-inn{background:#2b103b;border-color:#6b21a8;color:#e9d5ff}
  /* Right column */
  .builder{display:grid;gap:14px}
  .canvas{background:linear-gradient(180deg,#0b1226,#050a1a);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .canvas header{padding:14px;border-bottom:1px solid var(--border)}
  .canvas main{padding:12px 14px 16px}
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
  label{font-size:13px;color:#cbd5e1;margin-bottom:6px;display:block}
  input[type=text], select, textarea, input[type=number]{
    width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a3a56;background:#0c1427;color:var(--ink)
  }
  textarea{min-height:84px;resize:vertical}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid #334155;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer;background:#0c1427;color:#cbd5e1}
  .chip.active{border-color:#3b82f6;box-shadow:inset 0 0 0 1px #3b82f6}
  .note{color:var(--muted);font-size:12px}
  .initiatives{display:grid;gap:12px}
  .card{background:linear-gradient(180deg,#0f172a,#0b1226);border:1px solid #22304a;border-radius:14px;padding:12px;position:relative}
  .toolbar{position:absolute;right:8px;top:8px;display:flex;gap:6px}
  .icon-btn{width:28px;height:28px;border-radius:10px;border:1px solid #334155;background:#0b1226;color:#cbd5e1;cursor:pointer}
  .row{display:grid;grid-template-columns: 2fr 1fr 1fr 1fr;gap:10px}
  .score{display:flex;gap:8px;align-items:center}
  .score input{width:64px}
  .vote{display:flex;gap:8px;align-items:center;margin-top:6px}
  .dot{width:10px;height:10px;border-radius:999px;background:var(--accent)}
  .badge{padding:3px 8px;border-radius:999px;border:1px solid #334155;color:#cbd5e1;font-size:12px}
  .total{font-weight:700}
  footer.actions{display:flex;gap:10px;justify-content:flex-end;padding:10px 0}
  .empty{border:2px dashed #24324a;border-radius:14px;text-align:center;padding:18px;color:#9db1cf}
  @media (max-width:1100px){ .wrap{grid-template-columns:1fr} .list{max-height:none} }
</style>
</head>
<body>

<header>
  <div>
    <h1>Stage 2 — Action Builder</h1>
    <div class="subtitle">
      For each <strong>“What’s different?”</strong> item, define the <strong>initiatives</strong> that make it real.
      Tag enablers, assign owners, choose a time horizon, and score <em>Impact / Feasibility / Trust</em>.
      Your work here becomes the input to Stage 3 (12-month Frontier Action Plan).
    </div>
  </div>
  <div class="bar">
    <label for="importFile" class="btn btn-outline" style="cursor:pointer">← Import Stage-1 JSON</label>
    <input id="importFile" type="file" accept=".json" style="display:none" />
    <button class="btn btn-outline" id="exportJSON">Export Initiatives (JSON)</button>
    <button class="btn btn-outline" id="exportCSV">Export Initiatives (CSV)</button>
    <button class="btn btn-green" id="prepStage3">Prepare for Stage 3</button>
  </div>
</header>

<section class="wrap">
  <!-- LEFT: “What’s different?” list -->
  <div class="panel">
    <header><strong>What’s different? (from Stage 1)</strong></header>
    <div class="list" id="diffList">
      <div class="empty">Import your Stage-1 JSON to see items here, or add a quick example below.</div>
      <div style="padding:10px 10px 14px">
        <button class="btn btn-accent" id="seed">+ Seed with examples</button>
      </div>
    </div>
  </div>

  <!-- RIGHT: Builder -->
  <div class="builder">
    <div class="canvas" id="builderCanvas">
      <header>
        <div id="activeDiffTitle"><em>Select a “What’s different?” item to start designing initiatives.</em></div>
      </header>
      <main>
        <div class="grid cols-2">
          <div>
            <label>Initiative name</label>
            <input type="text" id="initName" placeholder="e.g., Roll out Employee Copilot program to Sales & Support" />
          </div>
          <div>
            <label>Owner</label>
            <input type="text" id="initOwner" placeholder="Function / team name" />
          </div>
        </div>

        <div class="grid cols-3" style="margin-top:8px">
          <div>
            <label>Time horizon</label>
            <select id="initHorizon">
              <option value="0-3">0–3 months (Quick Win)</option>
              <option value="3-6">3–6 months (Scale-Up)</option>
              <option value="6-12">6–12 months (Transformation)</option>
            </select>
          </div>
          <div>
            <label>Primary KPI</label>
            <input type="text" id="initKPI" placeholder="e.g., +10% win rate, -30% cycle time" />
          </div>
          <div>
            <label>Target</label>
            <input type="text" id="initTarget" placeholder="e.g., +10%, < 2 days, $2M" />
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Enablers (select all that apply)</label>
          <div class="chips" id="enablers">
            <span class="chip" data-val="Data">Data</span>
            <span class="chip" data-val="Skills">Skills</span>
            <span class="chip" data-val="Governance">Governance</span>
            <span class="chip" data-val="Technology">Technology</span>
            <span class="chip" data-val="Culture">Culture</span>
          </div>
        </div>

        <div class="grid cols-2" style="margin-top:8px">
          <div>
            <label>Dependencies / prerequisites</label>
            <textarea id="initDeps" placeholder="Systems, approvals, integrations, data access, etc."></textarea>
          </div>
          <div>
            <label>Description (how this makes the change real)</label>
            <textarea id="initDesc" placeholder="Briefly explain how this initiative delivers the desired difference."></textarea>
          </div>
        </div>

        <div class="grid cols-3" style="margin-top:8px">
          <div class="score">
            <label style="width:100%">Impact (1–5)</label>
            <input type="number" min="1" max="5" id="sImpact" value="4" />
          </div>
          <div class="score">
            <label style="width:100%">Feasibility (1–5)</label>
            <input type="number" min="1" max="5" id="sFeas" value="3" />
          </div>
          <div class="score">
            <label style="width:100%">Trust / Risk Fit (1–5)</label>
            <input type="number" min="1" max="5" id="sTrust" value="4" />
          </div>
        </div>
        <div class="note">Priority Score = (Impact × Feasibility) + Trust. Use this to sort and pick your top 3–5 initiatives.</div>

        <footer class="actions">
          <button class="btn btn-accent" id="addInitiative">+ Add initiative</button>
          <button class="btn btn-outline" id="clearForm">Clear</button>
        </footer>

        <hr style="border-color:#1f2a3d;border-width:0 0 1px;margin:10px 0 14px"/>

        <div id="initList">
          <div class="empty">No initiatives yet. Add one above.</div>
        </div>
      </main>
    </div>
  </div>
</section>

<script>
  // --- State ---
  let diffs = [];   // Stage-1 items
  let activeDiffId = null;
  let initiatives = []; // {id, diffId, lane, diffTitle, name, owner, horizon, kpi, target, enablers[], deps, desc, impact, feas, trust, score, votes}

  // --- Helpers ---
  const q = sel => document.querySelector(sel);
  const qa = sel => Array.from(document.querySelectorAll(sel));
  function uid(){ return Math.random().toString(36).slice(2,10) }
  function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])) }

  // --- Import Stage-1 JSON ---
  q('#importFile').addEventListener('change', e=>{
    const f = e.target.files[0]; if(!f) return;
    const rdr = new FileReader();
    rdr.onload = ()=>{ try{
      const arr = JSON.parse(rdr.result);
      // Expect: [{lane,title,metric,evidence,votes}]
      diffs = arr.map(x=>({
        id: uid(),
        lane: x.lane || 'employee',
        title: x.title || '',
        metric: x.metric || '',
        evidence: x.evidence || '',
        votes: x.votes || 0
      }));
      renderDiffs();
    }catch(err){ alert('Could not parse JSON.'); } };
    rdr.readAsText(f);
  });

  // Seed examples
  q('#seed').addEventListener('click', ()=>{
    diffs = [
      {id:uid(), lane:'employee', title:'Every employee uses Copilot to automate routine tasks.', metric:'2 hrs/week saved', evidence:'>70% adoption', votes:3},
      {id:uid(), lane:'customer', title:'We predict and resolve service issues before customers call.', metric:'-25% inbound', evidence:'NPS +8', votes:2},
      {id:uid(), lane:'process',  title:'Cycle time from request to decision drops from weeks to days.', metric:'< 48 hours', evidence:'Ops KPIs improved', votes:1},
      {id:uid(), lane:'innovation',title:'A monthly cadence of AI prototypes informs new offerings.', metric:'12 prototypes/yr', evidence:'New revenue lines', votes:0},
    ];
    renderDiffs();
  });

  function lanePill(lane){
    const map = {employee:'lane-emp',customer:'lane-cust',process:'lane-proc',innovation:'lane-inn'};
    return `<span class="pill ${map[lane]||''}">${lane[0].toUpperCase()+lane.slice(1)}</span>`;
  }

  function renderDiffs(){
    const list = q('#diffList');
    list.innerHTML = '';
    if(!diffs.length){
      list.innerHTML = `<div class="empty">Import your Stage-1 JSON to see items here.</div>`;
      return;
    }
    diffs.forEach(d=>{
      const el = document.createElement('div');
      el.className = 'diff';
      el.innerHTML = `<div><strong>${escapeHTML(d.title)}</strong></div>
                      <small>Metric: ${escapeHTML(d.metric||'-')} • Evidence: ${escapeHTML(d.evidence||'-')} • Votes: ${d.votes||0}</small><br/>
                      ${lanePill(d.lane)}`;
      el.addEventListener('click', ()=>selectDiff(d.id));
      list.appendChild(el);
    });
    // auto select first
    if(!activeDiffId && diffs[0]) selectDiff(diffs[0].id);
  }

  function selectDiff(id){
    activeDiffId = id;
    const d = diffs.find(x=>x.id===id);
    q('#activeDiffTitle').innerHTML = `<strong>Building initiatives for:</strong> ${escapeHTML(d.title)} ${lanePill(d.lane)}`;
    renderInitList();
  }

  // Enabler chips
  qa('#enablers .chip').forEach(chip=>{
    chip.addEventListener('click', ()=> chip.classList.toggle('active'));
  });

  // Add initiative
  q('#addInitiative').addEventListener('click', ()=>{
    if(!activeDiffId){ alert('Select a “What’s different?” item first.'); return; }
    const name = q('#initName').value.trim();
    if(!name) return alert('Please enter an initiative name.');
    const owner = q('#initOwner').value.trim();
    const horizon = q('#initHorizon').value;
    const kpi = q('#initKPI').value.trim();
    const target = q('#initTarget').value.trim();
    const enablers = qa('#enablers .chip.active').map(c=>c.dataset.val);
    const deps = q('#initDeps').value.trim();
    const desc = q('#initDesc').value.trim();
    const impact = Number(q('#sImpact').value||0);
    const feas = Number(q('#sFeas').value||0);
    const trust = Number(q('#sTrust').value||0);
    const score = (impact*feas)+trust;

    const d = diffs.find(x=>x.id===activeDiffId);
    initiatives.push({
      id: uid(), diffId: activeDiffId, lane: d.lane, diffTitle: d.title,
      name, owner, horizon, kpi, target, enablers, deps, desc, impact, feas, trust, score, votes:0
    });
    clearForm();
    renderInitList();
  });

  q('#clearForm').addEventListener('click', clearForm);
  function clearForm(){
    ['#initName','#initOwner','#initKPI','#initTarget','#initDeps','#initDesc'].forEach(sel=>q(sel).value='');
    q('#initHorizon').value='0-3'; q('#sImpact').value=4; q('#sFeas').value=3; q('#sTrust').value=4;
    qa('#enablers .chip').forEach(c=>c.classList.remove('active'));
  }

  function renderInitList(){
    const cont = q('#initList');
    const mine = initiatives.filter(i=>i.diffId===activeDiffId);
    cont.innerHTML = '';
    if(!mine.length){ cont.innerHTML = `<div class="empty">No initiatives yet for this item. Add one above.</div>`; return; }
    // sort by score desc
    mine.sort((a,b)=>b.score-a.score);
    mine.forEach(i=>{
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `
        <div class="toolbar">
          <button class="icon-btn" title="Vote">●</button>
          <button class="icon-btn" title="Delete">🗑</button>
        </div>
        <div class="row">
          <div><strong>${escapeHTML(i.name)}</strong><div class="note">For: ${escapeHTML(i.diffTitle)}</div></div>
          <div><span class="badge">Owner: ${escapeHTML(i.owner||'–')}</span></div>
          <div><span class="badge">Horizon: ${escapeHTML(i.horizon)}</span></div>
          <div><span class="badge">Votes: <span class="total">${i.votes||0}</span></span></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>KPI: <strong>${escapeHTML(i.kpi||'–')}</strong></div>
          <div>Target: <strong>${escapeHTML(i.target||'–')}</strong></div>
          <div>Enablers: <strong>${i.enablers.join(', ')||'–'}</strong></div>
          <div>Score: <strong>${i.score.toFixed(1)}</strong> <span class="note">(I×F + T)</span></div>
        </div>
        <div style="margin-top:8px">Dependencies: ${escapeHTML(i.deps||'–')}</div>
        <div style="margin-top:6px">Description: ${escapeHTML(i.desc||'–')}</div>
      `;
      const [voteBtn, delBtn] = card.querySelectorAll('.icon-btn');
      voteBtn.addEventListener('click', ()=>{ i.votes=(i.votes||0)+1; renderInitList(); });
      delBtn.addEventListener('click', ()=>{ if(confirm('Delete this initiative?')){ initiatives = initiatives.filter(x=>x.id!==i.id); renderInitList(); }});
      cont.appendChild(card);
    });
  }

  // Exports
  q('#exportJSON').addEventListener('click', ()=>{
    download('stage2-initiatives.json', JSON.stringify(initiatives,null,2));
  });
  q('#exportCSV').addEventListener('click', ()=>{
    const head = ['lane','diffTitle','name','owner','horizon','kpi','target','enablers','deps','desc','impact','feas','trust','score','votes'];
    const rows = initiatives.map(i=> head.map(k=>{
      let v = i[k];
      if(Array.isArray(v)) v = v.join('|');
      v = (v==null?'':String(v)).replace(/"/g,'""');
      return /[",\n]/.test(v) ? `"${v}"` : v;
    }).join(','));
    download('stage2-initiatives.csv', head.join(',')+'\n'+rows.join('\n'));
  });
  q('#prepStage3').addEventListener('click', ()=>{
    // minimal payload for timeline: group by horizon
    const payload = {
      generatedAt: new Date().toISOString(),
      horizons: {
        '0-3': initiatives.filter(i=>i.horizon==='0-3'),
        '3-6': initiatives.filter(i=>i.horizon==='3-6'),
        '6-12': initiatives.filter(i=>i.horizon==='6-12')
      }
    };
    download('stage3-input.json', JSON.stringify(payload,null,2));
    alert('Saved Stage-3 input (stage3-input.json). Load this in the Stage-3 timeline mockup.');
  });

  function download(filename, text){
    const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // init
  renderDiffs();
</script>
</body>
</html>
