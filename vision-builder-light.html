<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Frontier — Vision Builder (Light, AI Steering + Live Voting)</title>
<style>
  :root{
    --bg:#f7fafc; --card:#ffffff; --ink:#1f2937; --muted:#556581;
    --primary:#3b82f6; --accent:#10b981; --warn:#f59e0b; --violet:#8b5cf6;
    --border:#e5e7eb; --shadow:0 10px 24px rgba(31,41,55,.12); --radius:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--ink);
    background: radial-gradient(1100px 480px at 80% -10%, #e8f1ff 0%, #f5fbff 40%, var(--bg) 70%);
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }
  header{padding:18px 18px 8px; display:flex; gap:16px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap}
  h1{margin:.2rem 0 .3rem; font-size:26px}
  .sub{color:var(--muted); max-width:980px}
  .nav{display:flex; gap:8px; flex-wrap:wrap}
  .tab{background:#fff; border:1px solid #d8dee8; color:#1f2937; padding:8px 12px; border-radius:10px; cursor:pointer}
  .tab.active{border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.18) inset}
  .wrap{padding:10px 18px 24px; display:grid; gap:16px}

  .panel{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
  .panel header{padding:12px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
  .panel main{padding:14px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .grid{display:grid; gap:12px}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-3{grid-template-columns:repeat(3,1fr)}

  label{display:block; font-size:13px; color:#42506b; margin:8px 0 6px}
  input, select, textarea{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid #d8dee8; background:#fff; color:#1f2937
  }
  input:focus, select:focus, textarea:focus{outline:none; border-color:#c4d5ff; box-shadow:0 0 0 3px rgba(59,130,246,.15)}
  .counter{font-size:12px; color:#64748b; text-align:right}

  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{border:1px solid #d7e0ee; border-radius:999px; padding:6px 10px; background:#fff; color:#334155; cursor:pointer; font-size:13px}
  .chip.active{border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.18) inset}
  .token{display:inline-flex; gap:6px; align-items:center; border:1px solid #d7e0ee; border-radius:12px; padding:6px 10px; background:#fff; color:#334155; cursor:pointer}
  .ai{font-size:11px; color:#065f46; background:#ecfdf5; border:1px solid #a7f3d0; border-radius:999px; padding:2px 6px}
  .small{font-size:12px; color:#6b7280}
  .hint{font-size:12px; color:#6b7280}

  .btn{background:#eff6ff; color:#0f3a8a; border:1px solid #cfe0ff; padding:10px 14px; border-radius:12px; cursor:pointer}
  .btn:hover{background:#e6f0ff}
  .btn-primary{background:linear-gradient(180deg,#60a5fa,#3b82f6); color:#fff; border:1px solid #3b82f6}
  .btn-ghost{background:#fff; border:1px solid #d8dee8; color:#334155}
  .btn-warn{background:#fff7ed; color:#9a3412; border:1px solid #fed7aa}
  .btn-small{padding:6px 10px; border-radius:10px; font-size:14px}

  .status{font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #e2e8f0}
  .s-open{background:#f0f9ff; color:#075985; border-color:#bae6fd}
  .s-locked{background:#fff7ed; color:#9a3412; border-color:#fed7aa}

  .list{display:grid; gap:10px}
  .card{background:#fff; border:1px solid #e7ecf4; border-radius:12px; padding:10px 12px; box-shadow:0 6px 14px rgba(15,23,42,.06)}
  .two{display:grid; grid-template-columns:1fr 360px; gap:16px}
  .winner{background:#ecfeff; border:1px solid #bae6fd; color:#155e75; padding:10px 12px; border-radius:12px}
  .vote{display:flex; gap:8px; align-items:center}
  .dot{width:12px; height:12px; border-radius:999px; background:#3b82f6}
  .emailbox{width:100%; min-height:140px; padding:10px; border-radius:12px; border:1px solid #d8dee8}
</style>
</head>
<body>

<header>
  <div>
    <h1>Vision Builder — AI Steering + Live Voting</h1>
    <div class="sub">
      Teams craft a concise vision statement, assisted by <strong>AI-suggested phrases</strong> derived from your initiatives.
      Facilitator sees statements in real time, <strong>locks for voting</strong>, selects a winner, and exports the event pack (JSON/Markdown + an email draft).
    </div>
  </div>
  <nav class="nav" id="nav"></nav>
</header>

<section class="wrap">
  <!-- TEAM / PARTICIPANT -->
  <div id="screen-team" class="panel" style="display:none">
    <header>
      <strong>Participant — Build the Vision (with AI Steering)</strong>
      <div class="row">
        <span id="lockStateTeam" class="status s-open">OPEN</span>
        <span class="small">Write 140–280 chars. “AI-suggested” phrases reflect the initiatives shown below.</span>
      </div>
    </header>
    <main>
      <div class="grid cols-3">
        <div>
          <label for="teamSelect">Team *</label>
          <select id="teamSelect"></select>
        </div>
        <div>
          <label>Pick Tone</label>
          <div id="tone" class="chips">
            <span class="chip">Ambitious</span>
            <span class="chip">Practical</span>
            <span class="chip">Customer-obsessed</span>
            <span class="chip">People-first</span>
            <span class="chip">Operational</span>
          </div>
        </div>
        <div>
          <label>Word Bank</label>
          <div id="bank" class="chips" style="margin-top:6px;flex-wrap:wrap"></div>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:8px">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>Initiative Context (read-only)</strong>
            <div class="small">Import your own JSON or use seeds</div>
          </div>
          <div id="initList" class="list" style="margin-top:6px"></div>
          <div class="row" style="margin-top:8px">
            <button class="btn-ghost btn-small" id="seedInits">Seed initiatives</button>
            <label class="btn-ghost btn-small" style="cursor:pointer">Import JSON
              <input id="importInits" type="file" accept=".json" style="display:none"/>
            </label>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>AI Steering — Suggested Phrases</strong>
            <div class="small"><span class="ai">AI-suggested</span></div>
          </div>
          <div id="aiPhrases" class="chips" style="margin-top:6px;flex-wrap:wrap"></div>
          <div class="row" style="margin-top:8px">
            <button class="btn-ghost btn-small" id="regen">Regenerate</button>
            <span class="hint">Click any suggestion to insert it into your draft.</span>
          </div>
        </div>
      </div>

      <div style="margin-top:10px">
        <label for="compose">Compose Vision (140–280 chars)</label>
        <textarea id="compose" placeholder="Draft a concise, exec-ready statement…"></textarea>
        <div class="counter"><span id="charCount">0</span> chars</div>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="btn-primary" id="saveStatement">Save Statement</button>
        <button class="btn-ghost" id="clearCompose">Clear</button>
        <span class="small">After lock, join the Voting tab (2 votes per participant).</span>
      </div>
    </main>
  </div>

  <!-- FACILITATOR -->
  <div id="screen-fac" class="panel" style="display:none">
    <header>
      <strong>Facilitator — Live Statements, Voting & Exports</strong>
      <div class="row">
        <span id="lockStateFac" class="status s-open">OPEN</span>
        <button class="btn-ghost btn-small" id="seedStatements">Seed statements</button>
        <button class="btn-warn btn-small" id="toggleLock">Lock / Unlock</button>
        <button class="btn-ghost btn-small" id="exportJSON">Export JSON</button>
        <button class="btn-ghost btn-small" id="exportMD">Export Markdown</button>
        <button class="btn-ghost btn-small" id="buildEmail">Generate Email Draft</button>
      </div>
    </header>
    <main class="two">
      <!-- Left: statements -->
      <div class="panel" style="margin:0">
        <header><strong>Submitted Statements</strong> <span class="small" id="countLbl"></span></header>
        <main>
          <div id="statements" class="list"></div>
        </main>
      </div>

      <!-- Right: winner + email -->
      <aside class="panel" style="margin:0">
        <header><strong>Winning Statement & Email Draft</strong></header>
        <main>
          <div id="winnerBox" class="winner small">No winner yet. Lock to open voting; set winner once votes converge.</div>
          <div class="grid" style="margin-top:10px">
            <div>
              <label for="emailDraft">Email draft to participants</label>
              <textarea id="emailDraft" class="emailbox" placeholder="Click “Generate Email Draft” to populate…"></textarea>
              <div class="row" style="margin-top:8px">
                <button class="btn-ghost btn-small" id="copyEmail">Copy email</button>
                <a id="mailtoLink" class="btn-ghost btn-small" href="#" target="_blank">Open in email client</a>
              </div>
            </div>
          </div>
        </main>
      </aside>
    </main>
  </div>

  <!-- VOTING -->
  <div id="screen-vote" class="panel" style="display:none">
    <header>
      <strong>Participant — Vote on the Vision</strong>
      <div class="row">
        <span id="voteState" class="status s-locked">WAITING</span>
        <span class="small">You have <strong id="votesLeft">2</strong> votes.</span>
        <button class="btn-ghost btn-small" id="resetVotes">Reset my votes</button>
      </div>
    </header>
    <main>
      <div id="ballot" class="list"></div>
      <div class="hint" style="margin-top:8px">Click “+1 vote” on the statements you support (max 2 votes per browser/tab).</div>
    </main>
  </div>
</section>

<script>
  /* -------------------- Real-time channel -------------------- */
  const chan = new BroadcastChannel('frontier-vision-ai-steering');
  const publish = (type, payload) => chan.postMessage({type, payload});

  /* -------------------- Demo Teams + Seed Initiatives -------------------- */
  const DEMO_TEAMS = ['Team Nova','Team Atlas','Team Quasar','Team Meridian','Team Horizon','Team Vertex'];
  // initiative: {title, pillar, kpi, target}
  let initiatives = [];

  /* -------------------- State: Vision -------------------- */
  let locked = false;                  // lock enables voting
  let statements = [];                 // {id, team, text, votes, tone[], source:'human'}
  let winnerId = null;
  let myVotes = Number(localStorage.getItem('vision.votes2') || 2);

  /* -------------------- Helpers -------------------- */
  const q = s => document.querySelector(s);
  const qa = s => Array.from(document.querySelectorAll(s));
  const uid = () => Math.random().toString(36).slice(2,10);
  const esc = s => String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const cap = s => s ? s.charAt(0).toUpperCase()+s.slice(1) : s;

  /* -------------------- Router -------------------- */
  const screens = [
    {id:'screen-team', label:'Participant'},
    {id:'screen-fac', label:'Facilitator'},
    {id:'screen-vote', label:'Voting'}
  ];
  let current = 0;
  function renderNav(){
    const nav = q('#nav'); nav.innerHTML='';
    screens.forEach((s,i)=>{
      const b = document.createElement('button');
      b.className = 'tab'+(i===current?' active':'');
      b.textContent = s.label;
      b.addEventListener('click', ()=> show(i));
      nav.appendChild(b);
    });
  }
  function show(i){
    current = i; renderNav();
    screens.forEach((s,idx)=> q('#'+s.id).style.display = (idx===i?'block':'none'));
    if(i===0) renderTeam();
    if(i===1) renderFac();
    if(i===2) renderVote();
  }

  /* -------------------- INITIATIVE SEEDS / IMPORT -------------------- */
  function seedInitiatives(){
    initiatives = [
      mkInit('Employee Copilot pilot (HR & Sales)','employee','Hrs saved / FTE','2 hrs/wk'),
      mkInit('AI meeting recaps + next-step assistant','employee','Adoption','>70%'),
      mkInit('AI Sales Companion (next-best-offer)','customer','Win rate','+10%'),
      mkInit('Proactive service (resolve before call)','customer','Inbound volume','-25%'),
      mkInit('Workflow orchestrator (CRM↔ERP)','process','Cycle time','< 48h'),
      mkInit('AI Product Studio (monthly demos)','innovation','Prototypes/yr','12'),
      mkInit('Data monetization pilot','innovation','Data ARR','$600k'),
      mkInit('Customer personalization engine','customer','AOV','+7%')
    ];
    renderInitiatives();
    genAI();
  }
  function mkInit(title,pillar,kpi,target){ return {title,pillar,kpi,target}; }
  function renderInitiatives(){
    const list = q('#initList'); list.innerHTML='';
    initiatives.forEach(it=>{
      const div = document.createElement('div'); div.className='card';
      div.innerHTML = `<strong>${esc(it.title)}</strong>
        <div class="small">Pillar: ${esc(cap(it.pillar))} • KPI: <strong>${esc(it.kpi)}</strong> → <strong>${esc(it.target)}</strong></div>`;
      list.appendChild(div);
    });
  }
  q('#seedInits').onclick = seedInitiatives;
  q('#importInits').addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const fr = new FileReader();
    fr.onload = ()=>{
      try{
        const data = JSON.parse(fr.result);
        if(Array.isArray(data)) initiatives = data;
        else if(Array.isArray(data.initiatives)) initiatives = data.initiatives;
        else { alert('JSON must be an array of initiatives or {initiatives:[...]}.'); return; }
        renderInitiatives(); genAI();
      }catch{ alert('Could not parse JSON'); }
    };
    fr.readAsText(f);
  });

  /* -------------------- AI STEERING (client-side mock) -------------------- */
  function genAI(){
    // Build phrase options from initiatives (clearly marked as AI-suggested)
    // Mix templates: value, behavior, transformation, trust
    const t = (s)=>s.toLowerCase();
    const pick = (arr,n)=>arr.sort(()=>Math.random()-0.5).slice(0,n);
    const phrases = [];

    initiatives.forEach(it=>{
      const part1 = {
        employee: ['Copilot-augmented workforce','Every employee focuses on high-value work','Frontline amplified by AI'],
        customer: ['Proactive customer value','Personalised engagement at scale','Next-best-offer in every channel'],
        process: ['Intelligent operations','Decisions at the speed of data','Workflow from click to cash'],
        innovation: ['Innovation as a monthly habit','Data-backed product bets','AI Product Studio velocity']
      }[it.pillar] || ['AI-first execution'];

      const part2 = [
        `driving ${String(it.kpi).toLowerCase()} to ${it.target}`,
        `achieving ${it.target} ${t(it.kpi)}`,
        `hitting ${t(it.kpi)} ${it.target}`
      ];
      const part3 = [
        'with trust by design',
        'measured weekly in business outcomes',
        'embedded in day-to-day work'
      ];

      pick(part1,1).forEach(a=>{
        pick(part2,1).forEach(b=>{
          pick(part3,1).forEach(c=>{
            phrases.push(`${a}, ${b}, ${c}.`);
          });
        });
      });
    });

    // de-dupe & cap
    const uniq = [...new Set(phrases)].slice(0,24);
    const box = q('#aiPhrases'); box.innerHTML='';
    uniq.forEach(p=>{
      const tk = document.createElement('div'); tk.className='token'; tk.title='Insert into draft';
      tk.innerHTML = `<span>${esc(p)}</span> <span class="ai">AI-suggested</span>`;
      tk.onclick = ()=> insertIntoComposer(p);
      box.appendChild(tk);
    });

    // word bank from KPIs/targets
    const tokens = new Set();
    initiatives.forEach(it=>{
      tokens.add(`${it.kpi} ${it.target}`);
      if(it.pillar==='customer') tokens.add('Proactive service'); 
      if(it.pillar==='employee') tokens.add('Copilot adoption >70%');
      if(it.pillar==='process') tokens.add('Cycle time <48h');
      if(it.pillar==='innovation') tokens.add('12 prototypes/yr');
    });
    const bank = q('#bank'); bank.innerHTML='';
    [...tokens].slice(0,18).forEach(tk=>{
      const el = document.createElement('div'); el.className='token'; el.textContent=tk;
      el.onclick = ()=> insertIntoComposer(tk);
      bank.appendChild(el);
    });
  }
  q('#regen').onclick = genAI;

  /* -------------------- PARTICIPANT / TEAM UI -------------------- */
  function populateTeamSelect(){
    const sel = q('#teamSelect');
    if(sel.dataset.ready) return;
    sel.innerHTML = `<option value="">Select team…</option>` + DEMO_TEAMS.map(n=>`<option>${n}</option>`).join('');
    sel.value = localStorage.getItem('vision.team2') || '';
    sel.dataset.ready = '1';
  }
  const toneSel = new Set();
  function renderTeam(){
    q('#lockStateTeam').textContent = locked ? 'LOCKED' : 'OPEN';
    q('#lockStateTeam').className = 'status ' + (locked ? 's-locked' : 's-open');
    populateTeamSelect();
    qa('#tone .chip').forEach(ch=> ch.onclick = ()=>{ ch.classList.toggle('active'); const t=ch.textContent.trim(); ch.classList.contains('active')?toneSel.add(t):toneSel.delete(t); });
    q('#compose').oninput = ()=> q('#charCount').textContent = q('#compose').value.length;
    q('#clearCompose').onclick = ()=>{ q('#compose').value=''; q('#charCount').textContent=0; };
    q('#saveStatement').onclick = saveStatement;
    q('#saveStatement').disabled = locked;
    if(!initiatives.length) seedInitiatives();
  }
  function insertIntoComposer(text){
    const ta = q('#compose');
    const pos = ta.selectionStart || ta.value.length;
    ta.value = ta.value.slice(0,pos) + (ta.value && !ta.value.endsWith(' ') ? ' ' : '') + text + ' ' + ta.value.slice(pos);
    q('#charCount').textContent = ta.value.length; ta.focus();
  }
  function saveStatement(){
    const team = q('#teamSelect').value.trim();
    if(!team){ alert('Select your team.'); return; }
    const text = q('#compose').value.trim();
    if(text.length < 140 || text.length > 280){ alert('Please keep your statement 140–280 characters.'); return; }
    const payload = { id: uid(), team, text, votes:0, tone:Array.from(toneSel), source:'human' };
    localStorage.setItem('vision.team2', team);
    statements.push(payload);
    publish('vision:add', payload);
    q('#compose').value=''; q('#charCount').textContent=0;
    alert('Statement saved and sent to facilitator.');
  }

  /* -------------------- FACILITATOR -------------------- */
  function renderFac(){
    q('#lockStateFac').textContent = locked ? 'LOCKED (Voting Open)' : 'OPEN';
    q('#lockStateFac').className = 'status ' + (locked ? 's-locked' : 's-open');
    q('#countLbl').textContent = `${statements.length} statement${statements.length===1?'':'s'}`;

    const wrap = q('#statements'); wrap.innerHTML='';
    if(!statements.length){
      wrap.innerHTML = '<div class="card small">No statements yet. Ask teams to submit from the Participant tab.</div>';
    } else {
      statements.forEach(s=>{
        const div = document.createElement('div'); div.className='card';
        div.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div><strong>${esc(s.team)}</strong> <span class="small">(${(s.tone||[]).join(', ')||'—'})</span></div>
            <div class="row">
              <span class="small">Votes: <strong id="votes_${s.id}">${s.votes||0}</strong></span>
              <button class="btn-ghost btn-small" data-action="setWinner" data-id="${s.id}">Set as Winner</button>
            </div>
          </div>
          <div style="margin-top:6px">${esc(s.text)}</div>
          <div class="small" style="margin-top:6px">Source: ${s.source==='human'?'Team-authored with AI steering':'AI'}</div>
        `;
        wrap.appendChild(div);
      });
      wrap.querySelectorAll('button[data-action="setWinner"]').forEach(btn=>{
        btn.onclick = ()=>{
          winnerId = btn.dataset.id;
          publish('vision:winner', {id:winnerId});
          renderWinnerBox();
        };
      });
    }
    renderWinnerBox();
  }
  function renderWinnerBox(){
    const box = q('#winnerBox');
    const w = statements.find(x=>x.id===winnerId);
    if(!w){ box.className='winner small'; box.textContent='No winner yet. Lock to open voting; set winner once votes converge.'; return; }
    box.className='winner';
    box.innerHTML = `<div class="small">Winning statement from <strong>${esc(w.team)}</strong></div>
      <div style="margin-top:6px"><strong>${esc(w.text)}</strong></div>
      <div class="small" style="margin-top:6px">Tone: ${esc((w.tone||[]).join(', ')||'—')}</div>`;
  }

  // Facilitator controls
  q('#toggleLock').onclick = ()=>{
    locked = !locked;
    publish('state:lock', {locked});
    renderFac(); renderTeam(); renderVote();
  };
  q('#seedStatements').onclick = ()=>{
    const seed = [
      {team:'Team Nova', text:'We are an AI-empowered organization where every employee is augmented by Copilot, customer needs are anticipated, and decisions move at the speed of data — turning innovation into a monthly habit with trust by design.', tone:['Ambitious','People-first'], votes:2, source:'human'},
      {team:'Team Atlas', text:'In 12 months we operate as a trusted, data-driven enterprise: employees focus on high-value work, customer engagement is proactive, and intelligent operations shrink cycle time from weeks to days.', tone:['Practical','Operational'], votes:1, source:'human'}
    ].map(s=> ({id:uid(), ...s}));
    statements.push(...seed);
    publish('vision:seed', seed);
    renderFac(); renderVote();
  };

  // Exports
  q('#exportJSON').onclick = ()=>{
    const payload = {
      generatedAt:new Date().toISOString(),
      locked, winnerId, statements,
      initiatives
    };
    download('vision-event-pack.json', JSON.stringify(payload,null,2), 'application/json');
  };
  q('#exportMD').onclick = ()=>{
    const w = statements.find(x=>x.id===winnerId);
    const md = `# Shared AI Vision — Workshop Output

**Vision (final):**
> ${w ? w.text : '(winner not set yet)'}

**Tone cues:** ${w ? (w.tone||[]).join(', ') : '—'}

---

## Considered Statements (with votes)
${statements.map(s=>`- (${s.team}, ${s.votes||0} votes) ${s.text}`).join('\n')}

## Initiative Context
${initiatives.map(i=>`- **${i.title}** — Pillar: ${cap(i.pillar)} — KPI: ${i.kpi} → ${i.target}`).join('\n')}
`;
    download('vision-summary.md', md, 'text/markdown');
  };
  function download(filename, text, type){
    const blob = new Blob([text], {type:type||'text/plain;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
  }

  // Email draft
  q('#buildEmail').onclick = ()=>{
    const w = statements.find(x=>x.id===winnerId);
    const subject = encodeURIComponent('Workshop: Shared AI Vision & Next Steps');
    const body = [
      'Hi all,',
      '',
      'Thanks for contributing to today’s Frontier futures workshop. Here’s the winning Shared AI Vision statement:',
      '',
      w ? `“${w.text}” (from ${w.team})` : '(winner not set yet)',
      '',
      'We also considered:',
      ...statements.map(s=>`• (${s.team}, ${s.votes||0} votes) ${s.text}`),
      '',
      'Initiative context that informed the AI Steering suggestions:',
      ...initiatives.map(i=>`• ${i.title} — ${i.kpi} → ${i.target}`),
      '',
      'Next steps:',
      '• Draft Frontier Action Plan based on prioritized initiatives',
      '• Confirm success metrics and owners',
      '',
      'Best,',
      'Facilitator'
    ].join('\n');
    const draft = `Subject: Workshop: Shared AI Vision & Next Steps\n\n${decodeURIComponent(body)}`;
    q('#emailDraft').value = draft;
    q('#mailtoLink').href = `mailto:?subject=${subject}&body=${body}`;
  };
  q('#copyEmail').onclick = async ()=> {
    try{
      await navigator.clipboard.writeText(q('#emailDraft').value||'');
      alert('Email draft copied.');
    }catch{}
  };

  /* -------------------- Voting -------------------- */
  function renderVote(){
    q('#voteState').textContent = locked ? 'VOTING OPEN' : 'WAITING';
    q('#voteState').className = 'status ' + (locked ? 's-open' : 's-locked');
    q('#votesLeft').textContent = myVotes;
    const cont = q('#ballot'); cont.innerHTML='';
    if(!locked){ cont.innerHTML = '<div class="card small">Voting opens when the facilitator locks.</div>'; return; }
    const list = [...statements].sort((a,b)=> (b.votes||0)-(a.votes||0));
    list.forEach(s=>{
      const div = document.createElement('div'); div.className='card';
      div.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div><strong>${esc(s.team)}</strong></div>
          <div class="vote">
            <div class="dot"></div>
            <button class="btn-ghost btn-small" data-id="${s.id}">+1 vote</button>
            <span>Votes: <strong id="v_${s.id}">${s.votes||0}</strong></span>
          </div>
        </div>
        <div style="margin-top:6px">${esc(s.text)}</div>
      `;
      cont.appendChild(div);
    });
    cont.querySelectorAll('button[data-id]').forEach(btn=>{
      btn.onclick = ()=>{
        if(!locked) return;
        if(myVotes<=0){ alert('You have used your 2 votes.'); return; }
        myVotes -= 1;
        localStorage.setItem('vision.votes2', String(myVotes));
        q('#votesLeft').textContent = myVotes;
        const id = btn.dataset.id;
        const st = statements.find(x=>x.id===id);
        if(st){ st.votes = (st.votes||0)+1; const el = q('#v_'+id); if(el) el.textContent = st.votes; }
        publish('vote:add', {id});
        autoSuggestWinner();
      };
    });
  }
  q('#resetVotes').onclick = ()=>{ myVotes = 2; localStorage.setItem('vision.votes2','2'); q('#votesLeft').textContent = myVotes; };

  function autoSuggestWinner(){
    if(!statements.length) return;
    const top = [...statements].sort((a,b)=> (b.votes||0)-(a.votes||0))[0];
    if(top && top.id !== winnerId){
      winnerId = top.id;
      publish('vision:winner', {id:winnerId});
      if(current===1) renderWinnerBox();
    }
  }

  /* -------------------- Channel listeners -------------------- */
  chan.onmessage = (e)=>{
    const {type, payload} = e.data || {};
    switch(type){
      case 'vision:add':
        statements.push(payload);
        if(current===1) renderFac();
        if(current===2) renderVote();
        break;
      case 'vision:seed':
        statements.push(...payload);
        if(current===1) renderFac();
        if(current===2) renderVote();
        break;
      case 'vote:add':
        {
          const st = statements.find(x=>x.id===payload.id);
          if(st){ st.votes = (st.votes||0)+1;
            const a = q('#votes_'+st.id); if(a) a.textContent = st.votes;
            const b = q('#v_'+st.id); if(b) b.textContent = st.votes;
          }
          if(current===1) renderFac();
        }
        break;
      case 'state:lock':
        locked = !!payload.locked;
        if(current===1) renderFac();
        if(current===0) renderTeam();
        if(current===2) renderVote();
        break;
      case 'vision:winner':
        winnerId = payload.id;
        if(current===1) renderWinnerBox();
        break;
    }
  };

  /* -------------------- Init -------------------- */
  function init(){
    renderNav(); show(0); // default to Participant
    populateTeamSelect();
    seedInitiatives();
  }
  init();
</script>
</body>
</html>
