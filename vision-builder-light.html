<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Frontier Workshop — Fresh Build (4 Screens)</title>
<style>
  :root{ --bg:#f7fafc; --card:#fff; --ink:#1f2937; --muted:#556581;
         --primary:#3b82f6; --accent:#10b981; --warn:#f59e0b;
         --border:#e5e7eb; --shadow:0 10px 24px rgba(31,41,55,.12); --r:16px; }
  *{box-sizing:border-box}
  body{margin:0; color:var(--ink);
       background:radial-gradient(1100px 480px at 80% -10%, #e8f1ff 0%, #f5fbff 40%, var(--bg) 70%);
       font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  header{padding:18px 18px 8px; display:flex; gap:16px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap}
  h1{margin:.2rem 0 .3rem; font-size:26px}
  .sub{color:var(--muted); max-width:980px}
  .nav{display:flex; gap:8px; flex-wrap:wrap}
  .tab{background:#fff; border:1px solid #d8dee8; color:#1f2937; padding:8px 12px; border-radius:10px; cursor:pointer}
  .tab.active{border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.18) inset}
  .wrap{padding:10px 18px 24px; display:grid; gap:16px}

  .panel{background:var(--card); border:1px solid var(--border); border-radius:var(--r); box-shadow:var(--shadow)}
  .panel header{padding:12px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
  .panel main{padding:14px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .grid{display:grid; gap:12px}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .two{display:grid; grid-template-columns:1.2fr .8fr; gap:16px}

  label{display:block; font-size:13px; color:#42506b; margin:8px 0 6px}
  input, select, textarea{width:100%; padding:10px 12px; border-radius:12px; border:1px solid #d8dee8; background:#fff; color:#1f2937}
  input:focus, select:focus, textarea:focus{outline:none; border-color:#c4d5ff; box-shadow:0 0 0 3px rgba(59,130,246,.15)}
  textarea{min-height:120px}
  .counter{font-size:12px; color:#64748b; text-align:right}

  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{border:1px solid #d7e0ee; border-radius:999px; padding:6px 10px; background:#fff; color:#334155; cursor:pointer; font-size:13px}
  .token{display:inline-flex; gap:6px; align-items:center; border:1px solid #d7e0ee; border-radius:12px; padding:6px 10px; background:#fff; color:#334155; cursor:pointer}
  .ai{font-size:11px; color:#065f46; background:#ecfdf5; border:1px solid #a7f3d0; border-radius:999px; padding:2px 6px}

  .small{font-size:12px; color:#6b7280}
  .status{font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #e2e8f0}
  .s-open{background:#f0f9ff; color:#075985; border-color:#bae6fd}
  .s-locked{background:#fff7ed; color:#9a3412; border-color:#fed7aa}

  .btn{background:#eff6ff; color:#0f3a8a; border:1px solid #cfe0ff; padding:10px 14px; border-radius:12px; cursor:pointer}
  .btn:hover{background:#e6f0ff}
  .btn-ghost{background:#fff; border:1px solid #d8dee8; color:#334155}
  .btn-warn{background:#fff7ed; color:#9a3412; border:1px solid #fed7aa}
  .btn-small{padding:6px 10px; border-radius:10px; font-size:14px}

  .card{background:#fff; border:1px solid #e7ecf4; border-radius:12px; padding:10px 12px; box-shadow:0 6px 14px rgba(15,23,42,.06)}
  .list{display:grid; gap:10px}
  .vote{display:flex; gap:8px; align-items:center}
  .dot{width:12px; height:12px; border-radius:999px; background:#3b82f6}

  /* Final Output boards & charts */
  .board{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
  .lane{background:#fff; border:2px dashed #d8dee8; border-radius:14px; min-height:200px; padding:10px}
  .lane h3{text-align:center; margin:0 0 8px; color:#1f3a8a}
  .icard{background:#fff; border:1px solid #e7ecf4; border-radius:12px; padding:8px; margin:8px 0; box-shadow:0 6px 14px rgba(15,23,42,.06)}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #d7e0ee; font-size:12px; background:#f8fafc; color:#334155}
  .kpi{font-size:13px; color:#334155}
  .winner{background:#ecfeff; border:1px solid #bae6fd; color:#155e75; padding:10px 12px; border-radius:12px}

  .chartbox{background:#fff; border:1px solid #e7ecf4; border-radius:14px; padding:10px; box-shadow:0 6px 14px rgba(15,23,42,.06)}
  .legend{display:flex; gap:8px; flex-wrap:wrap; font-size:12px; color:#334155}
  .legend .dot{width:10px; height:10px; border-radius:999px; display:inline-block}
  .spot{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
  .tile{background:#fff; border:1px solid #e7ecf4; border-radius:12px; padding:10px; box-shadow:0 6px 14px rgba(15,23,42,.06)}
</style>
</head>
<body>
<header>
  <div>
    <h1>Frontier Workshop — Fresh Build</h1>
    <div class="sub">1) Participant Vision Builder • 2) Participant Voting • 3) Facilitator (all statements) • 4) Final Output (winner + plan + chart + impact)</div>
  </div>
  <nav class="nav" id="nav"></nav>
</header>

<section class="wrap">
  <!-- 1) PARTICIPANT — VISION BUILDER -->
  <div id="screen-builder" class="panel" style="display:none">
    <header>
      <strong>Participant — Vision Statement Builder</strong>
      <div class="row"><span id="lockStateTeam" class="status s-open">OPEN</span><span class="small">Compose 120–280 chars. Click AI suggestions to insert.</span></div>
    </header>
    <main>
      <div class="grid cols-3">
        <div>
          <label for="teamSelect">Team *</label>
          <select id="teamSelect"></select>
        </div>
        <div>
          <label>Tone (optional)</label>
          <div id="tone" class="chips">
            <span class="chip">Ambitious</span>
            <span class="chip">Practical</span>
            <span class="chip">Customer-obsessed</span>
            <span class="chip">People-first</span>
            <span class="chip">Operational</span>
          </div>
        </div>
        <div>
          <label>AI Phrase Chips</label>
          <div id="aiChips" class="chips" style="margin-top:6px;flex-wrap:wrap"></div>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:8px">
        <div class="card">
          <strong>Initiative Context (read-only)</strong>
          <div id="initList" class="list" style="margin-top:6px"></div>
          <div class="row" style="margin-top:8px">
            <button class="btn-ghost btn-small" id="seedInits">Seed initiatives</button>
            <label class="btn-ghost btn-small" style="cursor:pointer">Import JSON
              <input id="importInits" type="file" accept=".json" style="display:none"/>
            </label>
            <button class="btn-ghost btn-small" id="regen">Regenerate AI Phrases</button>
          </div>
        </div>
        <div class="card">
          <label for="compose"><strong>Compose Vision</strong> (120–280 chars)</label>
          <textarea id="compose" placeholder="Draft a concise, exec-ready statement…"></textarea>
          <div class="counter"><span id="charCount">0</span> chars</div>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="saveStatement">Save Statement</button>
            <button class="btn-ghost" id="clearCompose">Clear</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- 2) PARTICIPANT — VOTING -->
  <div id="screen-voting" class="panel" style="display:none">
    <header>
      <strong>Participant — Voting</strong>
      <div class="row"><span id="voteState" class="status s-locked">WAITING</span><span class="small">You have <strong id="votesLeft">2</strong> votes</span><button class="btn-ghost btn-small" id="resetVotes">Reset my votes</button></div>
    </header>
    <main>
      <div id="ballot" class="list"></div>
      <div class="small" style="margin-top:8px">Click “+1 vote” on the statements you support (2 per browser/tab).</div>
    </main>
  </div>

  <!-- 3) FACILITATOR — ALL STATEMENTS -->
  <div id="screen-facilitator" class="panel" style="display:none">
    <header>
      <strong>Facilitator — All Vision Statements</strong>
      <div class="row">
        <span id="lockStateFac" class="status s-open">OPEN</span>
        <button class="btn-warn btn-small" id="toggleLock">Lock / Unlock Voting</button>
        <button class="btn-ghost btn-small" id="seedStatements">Seed sample statements</button>
        <button class="btn-ghost btn-small" id="clearAll">Clear all</button>
      </div>
    </header>
    <main>
      <div id="stmtList" class="list"></div>
    </main>
  </div>

  <!-- 4) FINAL OUTPUT — WINNER + PLAN + CHART + IMPACT -->
  <div id="screen-output" class="panel" style="display:none">
    <header>
      <strong>Final Output</strong>
      <div class="row">
        <label class="btn-ghost btn-small" style="cursor:pointer">Import FAP Plan JSON
          <input id="importPlan" type="file" accept=".json" style="display:none"/>
        </label>
        <button class="btn-ghost btn-small" id="seedPlan">Seed plan</button>
        <button class="btn-ghost btn-small" id="exportPack">Export Event Pack (JSON)</button>
        <button class="btn-ghost btn-small" id="exportMD">Export Markdown</button>
      </div>
    </header>
    <main class="two">
      <div class="grid">
        <div class="winner">
          <div class="small">Winning Vision</div>
          <div id="visionText" style="font-size:18px;font-weight:700;margin-top:6px">Awaiting winner…</div>
          <div id="visionMeta" class="small" style="margin-top:6px">Team: — • Tone: — • Votes: —</div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between"><strong>12-Month Frontier Action Plan</strong><span class="small">Sequenced initiatives with KPI targets</span></div>
          <div id="board" class="board" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="grid">
        <div class="chartbox">
          <strong>Portfolio Balance</strong>
          <canvas id="donut" width="360" height="240"></canvas>
          <div class="legend" style="margin-top:6px">
            <span><span class="dot" style="background:#3b82f6"></span> 0–3</span>
            <span><span class="dot" style="background:#10b981"></span> 3–6</span>
            <span><span class="dot" style="background:#f59e0b"></span> 6–12</span>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between"><strong>Impact Spotlight</strong><span class="small">Mock values — edit per client</span></div>
          <div id="spot" class="spot" style="margin-top:8px"></div>
        </div>
      </div>
    </main>
  </div>
</section>

<script>
/* ======================= Fresh State & Channel ======================= */
const CH = new BroadcastChannel('frontier-fresh-chan'); // new channel
const publish=(type,payload)=>CH.postMessage({type,payload});

const TEAMS=['Team Nova','Team Atlas','Team Quasar','Team Meridian','Team Horizon','Team Vertex'];
let initiatives=[];      // for AI chips
let statements=[];       // {id, team, text, tone[], votes}
let locked=false;        // voting lock
let winnerId=null;       // selected by facilitator
let plan={'0-3':[],'3-6':[],'6-12':[]}; // FAP
let myVotes=Number(localStorage.getItem('fresh.votes')||2);

/* ======================= Helpers ======================= */
const q=s=>document.querySelector(s), qa=s=>Array.from(document.querySelectorAll(s));
const uid=()=>Math.random().toString(36).slice(2,10);
const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const cap=s=>s? s[0].toUpperCase()+s.slice(1):s;
function dl(name,text,type){ const b=new Blob([text],{type:type||'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

/* ======================= Router ======================= */
const screens=[
  {id:'screen-builder',label:'1) Participant — Builder'},
  {id:'screen-voting',label:'2) Participant — Voting'},
  {id:'screen-facilitator',label:'3) Facilitator — Statements'},
  {id:'screen-output',label:'4) Final Output'}
];
let current=0;
function renderNav(){
  const nav=q('#nav'); nav.innerHTML='';
  screens.forEach((s,i)=>{
    const b=document.createElement('button');
    b.className='tab'+(i===current?' active':'');
    b.textContent=s.label; b.onclick=()=>show(i); nav.appendChild(b);
  });
}
function show(i){
  current=i; renderNav();
  screens.forEach((s,idx)=> q('#'+s.id).style.display=(idx===i?'block':'none'));
  if(i===0) renderBuilder();
  if(i===1) renderVoting();
  if(i===2) renderFacilitator();
  if(i===3) renderOutput();
}

/* ======================= Seed data ======================= */
function seedInitiatives(){
  initiatives=[
    {title:'Employee Copilot pilot (HR & Sales)',pillar:'employee',kpi:'Hrs saved / FTE',target:'2 hrs/wk'},
    {title:'AI meeting recaps + next-step assistant',pillar:'employee',kpi:'Adoption',target:'>70%'},
    {title:'AI Sales Companion (next-best-offer)',pillar:'customer',kpi:'Win rate',target:'+10%'},
    {title:'Proactive service (resolve before call)',pillar:'customer',kpi:'Inbound volume',target:'-25%'},
    {title:'Workflow orchestrator (CRM↔ERP)',pillar:'process',kpi:'Cycle time',target:'< 48h'},
    {title:'AI Product Studio (monthly demos)',pillar:'innovation',kpi:'Prototypes/yr',target:'12'},
    {title:'Data monetization pilot',pillar:'innovation',kpi:'Data ARR',target:'£600k'},
    {title:'Customer personalization engine',pillar:'customer',kpi:'AOV',target:'+7%'}
  ];
}
function seedPlan(){
  plan={'0-3':[
      {title:'Employee Copilot pilot (HR & Sales)',pillar:'employee',kpi:'Hrs saved / FTE',target:'2 hrs/wk'},
      {title:'AI meeting recaps + next-step assistant',pillar:'employee',kpi:'Adoption',target:'>70%'},
      {title:'Knowledge hub answers in 30s',pillar:'employee',kpi:'Time to answer',target:'<30s'}],
    '3-6':[
      {title:'AI Sales Companion (next-best-offer)',pillar:'customer',kpi:'Win rate',target:'+10%'},
      {title:'Proactive service (resolve before call)',pillar:'customer',kpi:'Inbound volume',target:'-25%'},
      {title:'Workflow orchestrator (CRM↔ERP)',pillar:'process',kpi:'Cycle time',target:'< 48h'}],
    '6-12':[
      {title:'AI Product Studio (monthly demos)',pillar:'innovation',kpi:'Prototypes/yr',target:'12'},
      {title:'Data monetization pilot',pillar:'innovation',kpi:'Data ARR',target:'£600k'},
      {title:'Intelligent ops dashboard',pillar:'process',kpi:'Observability',target:'Org-wide'}]
  };
}

/* ======================= 1) Participant — Builder ======================= */
function renderBuilder(){
  // lock state
  q('#lockStateTeam').textContent=locked?'LOCKED':'OPEN';
  q('#lockStateTeam').className='status '+(locked?'s-locked':'s-open');

  // teams
  const sel=q('#teamSelect');
  if(!sel.dataset.ready){
    sel.innerHTML=`<option value="">Select team…</option>` + TEAMS.map(n=>`<option>${n}</option>`).join('');
    sel.dataset.ready='1';
  }

  // tone chips
  qa('#tone .chip').forEach(ch=>{
    ch.onclick=()=> ch.classList.toggle('active');
  });

  // initiatives list & AI chips
  if(!initiatives.length) seedInitiatives();
  const il=q('#initList'); il.innerHTML='';
  initiatives.forEach(it=>{
    const d=document.createElement('div'); d.className='card';
    d.innerHTML=`<strong>${esc(it.title)}</strong>
      <div class="small">Pillar: ${cap(it.pillar)} • KPI: <strong>${esc(it.kpi)}</strong> → <strong>${esc(it.target)}</strong></div>`;
    il.appendChild(d);
  });
  buildAI();

  // composer
  q('#compose').oninput=()=> q('#charCount').textContent=q('#compose').value.length;
  q('#clearCompose').onclick=()=>{ q('#compose').value=''; q('#charCount').textContent=0; };
  q('#saveStatement').onclick=saveStatement;

  // imports & regenerate
  q('#seedInits').onclick=()=>{ seedInitiatives(); renderBuilder(); };
  q('#importInits').onchange=(e)=>{
    const f=e.target.files[0]; if(!f) return;
    const fr=new FileReader();
    fr.onload=()=>{ try{
        const data=JSON.parse(fr.result);
        initiatives = Array.isArray(data)?data:(Array.isArray(data.initiatives)?data.initiatives:[]);
        if(!initiatives.length) throw new Error('No initiatives array');
        renderBuilder();
      }catch{ alert('Invalid initiatives JSON'); } };
    fr.readAsText(f);
  };
  q('#regen').onclick=buildAI;
}
function buildAI(){
  const box=q('#aiChips'); box.innerHTML='';
  const phrases = [];
  const pick=(arr)=>arr[Math.floor(Math.random()*arr.length)];
  initiatives.forEach(it=>{
    const p1={employee:['Copilot-augmented workforce','Every employee focuses on high-value work'],
              customer:['Proactive customer value','Personalised at scale'],
              process:['Intelligent operations','Decisions at the speed of data'],
              innovation:['Innovation as a monthly habit','Data-backed product bets']}[it.pillar] || ['AI-first execution'];
    const p2=[`driving ${it.kpi.toLowerCase()} to ${it.target}`,`achieving ${it.target} ${it.kpi.toLowerCase()}`];
    const p3=['with trust by design','measured weekly in outcomes','embedded in day-to-day work'];
    phrases.push(`${pick(p1)}, ${pick(p2)}, ${pick(p3)}.`);
  });
  [...new Set(phrases)].slice(0,20).forEach(t=>{
    const el=document.createElement('div'); el.className='token';
    el.innerHTML=`<span>${esc(t)}</span> <span class="ai">AI</span>`;
    el.onclick=()=>{ const ta=q('#compose'); ta.value = (ta.value? ta.value+' ' : '') + t + ' '; q('#charCount').textContent=ta.value.length; };
    box.appendChild(el);
  });
}
function saveStatement(){
  if(locked){ alert('Voting is locked. Facilitator must unlock to add.'); return; }
  const team=q('#teamSelect').value.trim(); if(!team){ alert('Select your team.'); return; }
  const text=q('#compose').value.trim();
  if(text.length<120||text.length>280){ alert('Keep your statement 120–280 characters.'); return; }
  const tone=qa('#tone .chip.active').map(x=>x.textContent.trim());
  const obj={id:uid(), team, text, tone, votes:0};
  statements.push(obj); publish('vision:add',obj);
  q('#compose').value=''; q('#charCount').textContent=0;
  alert('Saved. It will appear on the Facilitator screen and in Voting when opened.');
}

/* ======================= 2) Participant — Voting ======================= */
function renderVoting(){
  q('#voteState').textContent=locked?'VOTING OPEN':'WAITING';
  q('#voteState').className='status '+(locked?'s-open':'s-locked');
  q('#votesLeft').textContent=myVotes;
  const cont=q('#ballot'); cont.innerHTML='';
  if(!locked){ cont.innerHTML='<div class="card small">Voting opens when the facilitator locks.</div>'; return; }
  const list=[...statements].sort((a,b)=>(b.votes||0)-(a.votes||0));
  list.forEach(s=>{
    const d=document.createElement('div'); d.className='card';
    d.innerHTML=`<div class="row" style="justify-content:space-between">
      <div><strong>${esc(s.team)}</strong></div>
      <div class="vote">
        <div class="dot"></div>
        <button class="btn-ghost btn-small" data-id="${s.id}">+1 vote</button>
        <span>Votes: <strong id="v_${s.id}">${s.votes||0}</strong></span>
      </div>
    </div>
    <div style="margin-top:6px">${esc(s.text)}</div>`;
    cont.appendChild(d);
  });
  cont.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.onclick=()=>{
      if(!locked) return;
      if(myVotes<=0){ alert('You have used your 2 votes.'); return; }
      myVotes-=1; localStorage.setItem('fresh.votes',String(myVotes));
      q('#votesLeft').textContent=myVotes;
      const id=btn.dataset.id;
      const st=statements.find(x=>x.id===id);
      if(st){ st.votes=(st.votes||0)+1; q('#v_'+id).textContent=st.votes; publish('vote:add',{id}); }
    };
  });
}
q('#resetVotes').onclick=()=>{ myVotes=2; localStorage.setItem('fresh.votes','2'); q('#votesLeft').textContent=myVotes; };

/* ======================= 3) Facilitator — All Statements ======================= */
function renderFacilitator(){
  q('#lockStateFac').textContent=locked?'LOCKED (Voting Open)':'OPEN';
  q('#lockStateFac').className='status '+(locked?'s-locked':'s-open');

  const wrap=q('#stmtList'); wrap.innerHTML='';
  if(!statements.length){
    wrap.innerHTML='<div class="card small">No statements yet. Ask teams to use the Participant — Builder screen.</div>';
    return;
  }
  statements.forEach(s=>{
    const d=document.createElement('div'); d.className='card';
    d.innerHTML=`<div class="row" style="justify-content:space-between">
      <div><strong>${esc(s.team)}</strong> <span class="small">(${(s.tone||[]).join(', ')||'—'})</span></div>
      <div class="row">
        <span class="small">Votes: <strong id="votes_${s.id}">${s.votes||0}</strong></span>
        <button class="btn-ghost btn-small" data-win="${s.id}">Select Winner</button>
      </div>
    </div>
    <div style="margin-top:6px">${esc(s.text)}</div>`;
    wrap.appendChild(d);
  });
  wrap.querySelectorAll('button[data-win]').forEach(b=> b.onclick=()=>{
    winnerId=b.dataset.win; publish('vision:winner',{id:winnerId}); show(3); renderOutput();
  });
}
q('#toggleLock').onclick=()=>{ locked=!locked; publish('state:lock',{locked}); renderBuilder(); renderVoting(); renderFacilitator(); };
q('#seedStatements').onclick=()=>{
  const seed=[
    {id:uid(), team:'Team Nova', text:'We are an AI-empowered organization where Copilot augments every role, customer needs are anticipated, and decisions move at the speed of data — innovation as a monthly habit with trust by design.', tone:['Ambitious','People-first'], votes:3},
    {id:uid(), team:'Team Atlas', text:'In 12 months we operate as a trusted, data-driven enterprise: employees focus on high-value work, engagement is proactive, and intelligent operations shrink cycle time from weeks to days.', tone:['Practical','Operational'], votes:1}
  ];
  statements.push(...seed); publish('vision:seed',seed); renderFacilitator(); renderVoting();
};
q('#clearAll').onclick=()=>{ if(confirm('Clear all statements and votes?')){ statements=[]; winnerId=null; renderFacilitator(); renderVoting(); } };

/* ======================= 4) Final Output ======================= */
function winnerObj(){ return statements.find(s=>s.id===winnerId)||null; }
function renderOutput(){
  // vision
  const w=winnerObj();
  q('#visionText').textContent = w? w.text : 'Awaiting winner…';
  q('#visionMeta').textContent = w? `Team: ${w.team} • Tone: ${(w.tone||[]).join(', ')||'—'} • Votes: ${w.votes||0}` : 'Team: — • Tone: — • Votes: —';
  // plan lanes
  renderPlan();
  // donut + impact
  renderDonut();
  renderImpact();
}
function renderPlan(){
  const board=q('#board'); board.innerHTML='';
  [{k:'0-3',t:'0–3 months',n:'Quick wins / foundation'},
   {k:'3-6',t:'3–6 months',n:'Scale-ups'},
   {k:'6-12',t:'6–12 months',n:'Transformational'}].forEach(L=>{
    const col=document.createElement('div'); col.className='lane';
    col.innerHTML=`<h3>${L.t}</h3><div class="small">${L.n}</div>`;
    (plan[L.k]||[]).forEach(it=>{
      const c=document.createElement('div'); c.className='icard';
      c.innerHTML=`<div class="row" style="justify-content:space-between">
          <strong>${esc(it.title)}</strong><span class="pill">${esc(cap(it.pillar||'initiative'))}</span>
        </div>
        <div class="kpi">KPI: <strong>${esc(it.kpi||'—')}</strong> → <strong>${esc(it.target||'—')}</strong></div>`;
      col.appendChild(c);
    });
    board.appendChild(col);
  });
}
function counts(){ return {'0-3':(plan['0-3']||[]).length,'3-6':(plan['3-6']||[]).length,'6-12':(plan['6-12']||[]).length}; }
function renderDonut(){
  const c=q('#donut'); const ctx=c.getContext('2d'), W=c.width, H=c.height;
  ctx.clearRect(0,0,W,H);
  const r=90, cx=W/2, cy=H/2-5, inner=52, cols={'0-3':'#3b82f6','3-6':'#10b981','6-12':'#f59e0b'};
  const k=counts(); const total=Math.max(1,k['0-3']+k['3-6']+k['6-12']); let a=-Math.PI/2;
  ['0-3','3-6','6-12'].forEach(key=>{
    const frac=k[key]/total; const end=a+frac*2*Math.PI;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a,end); ctx.closePath(); ctx.fillStyle=cols[key]; ctx.globalAlpha=.85; ctx.fill(); a=end;
  });
  ctx.globalAlpha=1; ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(cx,cy,inner,0,2*Math.PI); ctx.fill();
  ctx.fillStyle='#475569'; ctx.font='12px system-ui'; ctx.textAlign='center'; ctx.fillText('Portfolio balance',cx,cy-2);
  ctx.font='bold 14px system-ui'; ctx.fillText(`${total} initiatives`,cx,cy+16);
}
function renderImpact(){
  const spot=q('#spot'); spot.innerHTML='';
  [
    {label:'Projected revenue uplift', val:'£1.8M–£2.4M (12m)', sub:'Sales & CX initiatives'},
    {label:'Productivity hours saved', val:'~2 hrs/FTE/wk', sub:'Copilot & automation'},
    {label:'Customer experience', val:'−20–25% inbound', sub:'Proactive service, AOV'},
    {label:'Risk posture', val:'−30–40% findings', sub:'Compliance monitors'},
    {label:'Innovation throughput', val:'12 prototypes/yr', sub:'AI Product Studio'},
    {label:'Cycle time', val:'< 48h avg', sub:'Workflow orchestrator'}
  ].forEach(t=>{
    const d=document.createElement('div'); d.className='tile';
    d.innerHTML=`<div class="small">${t.label}</div>
                 <div style="font-size:22px;font-weight:700;margin:2px 0 4px">${t.val}</div>
                 <div class="kpi">${t.sub}</div>`;
    spot.appendChild(d);
  });
}

/* Imports/Exports */
q('#seedPlan').onclick=()=>{ seedPlan(); renderOutput(); };
q('#importPlan').onchange=(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const fr=new FileReader();
  fr.onload=()=>{ try{
      const data=JSON.parse(fr.result);
      plan=data.plan?data.plan:(data['0-3']||data['3-6']||data['6-12']?data:plan);
      renderOutput();
    }catch{ alert('Could not parse plan JSON'); } };
  fr.readAsText(f);
};
q('#exportPack').onclick=()=> dl('frontier_event_pack.json', JSON.stringify({generatedAt:new Date().toISOString(), winner: winnerObj(), statements, plan},null,2),'application/json');
q('#exportMD').onclick=()=>{
  const w=winnerObj();
  const md=`# Workshop Final Output

## Winning Vision
${w? `> ${w.text}\n\n_Team:_ ${w.team}  \n_Tone:_ ${(w.tone||[]).join(', ')||'—'}  \n_Votes:_ ${w.votes||0}` : '> (winner not selected yet)'}

---

## Frontier Action Plan
### 0–3 months
${(plan['0-3']||[]).map(i=>`- **${i.title}** — KPI: ${i.kpi} → ${i.target}`).join('\n')||'—'}

### 3–6 months
${(plan['3-6']||[]).map(i=>`- **${i.title}** — KPI: ${i.kpi} → ${i.target}`).join('\n')||'—'}

### 6–12 months
${(plan['6-12']||[]).map(i=>`- **${i.title}** — KPI: ${i.kpi} → ${i.target}`).join('\n')||'—'}

---

## Impact Spotlight (mock)
- Revenue uplift: £1.8M–£2.4M (12m)
- Productivity: ~2 hrs/FTE/wk
- CX: −20–25% inbound
- Risk: −30–40% findings
- Innovation: 12 prototypes/yr
- Cycle time: < 48h
`;
  dl('frontier_output.md', md, 'text/markdown');
};

/* ======================= Channel listeners ======================= */
CH.onmessage=(e)=>{
  const {type,payload}=e.data||{};
  switch(type){
    case 'vision:add': statements.push(payload); if(current===1) renderVoting(); if(current===2) renderFacilitator(); break;
    case 'vision:seed': statements.push(...payload); if(current===1) renderVoting(); if(current===2) renderFacilitator(); break;
    case 'vote:add': {
      const st=statements.find(x=>x.id===payload.id);
      if(st){ st.votes=(st.votes||0)+1; const a=q('#v_'+st.id); if(a) a.textContent=st.votes; const b=q('#votes_'+st.id); if(b) b.textContent=st.votes; }
      if(current===2) renderFacilitator();
      break;
    }
    case 'state:lock': locked=!!payload.locked; if(current===0) renderBuilder(); if(current===1) renderVoting(); if(current===2) renderFacilitator(); break;
    case 'vision:winner': winnerId=payload.id; if(current===3) renderOutput(); break;
  }
};

/* ======================= Init ======================= */
function init(){
  renderNav(); show(0); // start on Participant — Builder
  seedInitiatives();     // give AI chips context
  seedPlan();            // so Final Output looks populated immediately if opened
}
init();
</script>
</body>
</html>
